import { useState, useEffect, useRef, Fragment } from "react";
import { initializeApp, getApps } from "firebase/app";
import {
  getDatabase,
  ref,
  set,
  get,
  update,
  remove,
  onValue,
  onDisconnect,
} from "firebase/database";

// ============== FIREBASE CONFIG ==============
const firebaseConfig = {
  apiKey: "AIzaSyDZPRiByz69HQa8b7GFMCJeqq56J3Y-bOY",
  authDomain: "step-by-step-279df.firebaseapp.com",
  databaseURL:
    "https://step-by-step-279df-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "step-by-step-279df",
  storageBucket: "step-by-step-279df.firebasestorage.app",
  messagingSenderId: "302641152597",
  appId: "1:302641152597:web:6479b9ae03104666cd8adc",
};

const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
const db = getDatabase(app);

const TelegramWebApp = (window as any).Telegram?.WebApp;
const ADMIN_WALLET = "UQAWqaIPFSg81l9MlgAx0HBE9o3gpJMhk1dnyryKJXhWNHIc";
const TONCENTER_API = "https://toncenter.com/api/v2";
const BOT_TOKEN = "8325421899:AAHRdmMYdjJMXmAVIynDsQtpUNsSeKkaOis";

// ============== CASE REWARDS ==============
const CASE_REWARDS: Record<string, any[]> = {
  cardboard: [
    { id: "stars_0_25", name: "0.25 â­ï¸", displayChance: "80%", realChance: 80, type: "stars", value: 0.25, emoji: "â­ï¸" },
    { id: "stars_0_75", name: "0.75 â­ï¸", displayChance: "10%", realChance: 10, type: "stars", value: 0.75, emoji: "â­ï¸" },
    { id: "stars_1_5", name: "1.5 â­ï¸", displayChance: "6%", realChance: 6, type: "stars", value: 1.5, emoji: "â­ï¸" },
    { id: "stars_5", name: "5 â­ï¸", displayChance: "2%", realChance: 2, type: "stars", value: 5, emoji: "â­ï¸" },
    { id: "bear", name: "ğŸ§¸", displayChance: "1.5%", realChance: 1.5, type: "collectible", emoji: "ğŸ§¸" },
    { id: "diamond_pro", name: "ğŸ’ PRO", displayChance: "0.5%", realChance: 0.5, type: "collectible", emoji: "ğŸ’" },
  ],
  diamond: [
    { id: "stars_8", name: "8 â­ï¸", displayChance: "70%", realChance: 70, type: "stars", value: 8, emoji: "â­ï¸" },
    { id: "bear", name: "ĞœĞ¸ÑˆĞºĞ° ğŸ§¸", displayChance: "15%", realChance: 15, type: "item", sellPrice: 20, emoji: "ğŸ§¸" },
    { id: "stars_25", name: "25 â­ï¸", displayChance: "9%", realChance: 9, type: "stars", value: 25, emoji: "â­ï¸" },
    { id: "stars_80", name: "80 â­ï¸", displayChance: "4%", realChance: 4, type: "stars", value: 80, emoji: "â­ï¸" },
    { id: "diamond_pro", name: "ĞĞ»Ğ¼Ğ°Ğ· PRO ğŸ’", displayChance: "0.6%", realChance: 0.6, type: "collectible", emoji: "ğŸ’" },
    { id: "snoop_pro", name: "Snoop Dog PRO ğŸ•", displayChance: "0.4%", realChance: 0.4, type: "collectible", emoji: "ğŸ•" },
  ],
  coal: [
    { id: "stars_2_5", name: "2.5 â­ï¸", displayChance: "60%", realChance: 60, type: "stars", value: 2.5, emoji: "â­ï¸" },
    { id: "stars_5", name: "5 â­ï¸", displayChance: "18%", realChance: 18, type: "stars", value: 5, emoji: "â­ï¸" },
    { id: "pickaxe", name: "ĞšĞ¸Ñ€ĞºĞ° â›ï¸", displayChance: "10%", realChance: 10, type: "item", sellPrice: 10, emoji: "â›ï¸" },
    { id: "stars_15", name: "15 â­ï¸", displayChance: "6%", realChance: 6, type: "stars", value: 15, emoji: "â­ï¸" },
    { id: "material", name: "ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ» ğŸ§±", displayChance: "5%", realChance: 5, type: "item", sellPrice: 40, emoji: "ğŸ§±" },
    { id: "brownie_pro", name: "Happy Brownie PRO ğŸ’©", displayChance: "1%", realChance: 1, type: "collectible", emoji: "ğŸ’©" },
  ],
  elite: [
    { id: "stars_200", name: "200 â­ï¸", displayChance: "75%", realChance: 75, type: "stars", value: 200, emoji: "â­ï¸" },
    { id: "stars_275", name: "275 â­ï¸", displayChance: "5%", realChance: 5, type: "stars", value: 275, emoji: "â­ï¸" },
    { id: "champagne", name: "ğŸ¾", displayChance: "17%", realChance: 17, type: "collectible", emoji: "ğŸ¾" },
    { id: "socks", name: "ĞĞ¾ÑĞºĞ¸ ğŸ§¦", displayChance: "2%", realChance: 2, type: "collectible", emoji: "ğŸ§¦" },
    { id: "lightsword", name: "Light Sword âš”ï¸", displayChance: "1%", realChance: 1, type: "collectible", emoji: "âš”ï¸" },
  ],
  platinum: [
    { id: "stars_35", name: "35 â­ï¸", displayChance: "55%", realChance: 55, type: "stars", value: 35, emoji: "â­ï¸" },
    { id: "stars_50", name: "50 â­ï¸", displayChance: "35%", realChance: 35, type: "stars", value: 50, emoji: "â­ï¸" },
    { id: "ring", name: "ğŸ’", displayChance: "5%", realChance: 5, type: "collectible", emoji: "ğŸ’" },
    { id: "bday", name: "B-day ğŸ—“", displayChance: "4%", realChance: 4, type: "item", sellPrice: 150, emoji: "ğŸ—“" },
    { id: "bday_pro", name: "B-Day PRO ğŸ“…", displayChance: "1%", realChance: 1, type: "collectible", emoji: "ğŸ“…" },
  ],
  gold: [
    { id: "stars_50", name: "50 â­ï¸", displayChance: "50%", realChance: 50, type: "stars", value: 50, emoji: "â­ï¸" },
    { id: "stars_125", name: "125 â­ï¸", displayChance: "35%", realChance: 35, type: "stars", value: 125, emoji: "â­ï¸" },
    { id: "clover", name: "ğŸ€ Clover Pin", displayChance: "10%", realChance: 10, type: "item", sellPrice: 200, emoji: "ğŸ€" },
    { id: "icecream", name: "Ice Cream ğŸ¦", displayChance: "3%", realChance: 3, type: "collectible", emoji: "ğŸ¦" },
    { id: "clover_pro", name: "ğŸ€ Clover Pin PRO", displayChance: "2%", realChance: 2, type: "collectible", emoji: "ğŸ€" },
  ],
  money: [
    { id: "stars_150", name: "150 â­ï¸", displayChance: "45%", realChance: 45, type: "stars", value: 150, emoji: "â­ï¸" },
    { id: "stars_75", name: "75 â­ï¸", displayChance: "40%", realChance: 40, type: "stars", value: 75, emoji: "â­ï¸" },
    { id: "trophy", name: "ğŸ†", displayChance: "5%", realChance: 5, type: "collectible", emoji: "ğŸ†" },
    { id: "gem", name: "ğŸ’", displayChance: "5%", realChance: 5, type: "collectible", emoji: "ğŸ’" },
    { id: "bday_happy", name: "Happy B-day ğŸ’ˆ", displayChance: "4%", realChance: 4, type: "collectible", emoji: "ğŸ’ˆ" },
    { id: "cigar", name: "Snoop Cigar ğŸš¬", displayChance: "1%", realChance: 1, type: "collectible", emoji: "ğŸš¬" },
  ],
  winter: [
    { id: "stars_20", name: "20 â­ï¸", displayChance: "60%", realChance: 60, type: "stars", value: 20, emoji: "â­ï¸" },
    { id: "stars_35", name: "35 â­ï¸", displayChance: "35%", realChance: 35, type: "stars", value: 35, emoji: "â­ï¸" },
    { id: "stars_80", name: "80 â­ï¸", displayChance: "3.5%", realChance: 3.5, type: "stars", value: 80, emoji: "â­ï¸" },
    { id: "snake", name: "ğŸ„ Lunar Snake 2025 ğŸ", displayChance: "1%", realChance: 1, type: "collectible", emoji: "ğŸ" },
    { id: "scarf", name: "ğŸ§£ Ğ—Ğ¸Ğ¼Ğ½ĞµĞµ ÑĞ¾ĞºÑ€Ğ¾Ğ²Ğ¸Ñ‰Ğµ", displayChance: "0.5%", realChance: 0.5, type: "collectible", emoji: "ğŸ§£" },
  ],
  major: [
    { id: "stars_500", name: "500 â­ï¸", displayChance: "50%", realChance: 50, type: "stars", value: 500, emoji: "â­ï¸" },
    { id: "stars_1000", name: "1000 â­ï¸", displayChance: "25%", realChance: 25, type: "stars", value: 1000, emoji: "â­ï¸" },
    { id: "stars_2500", name: "2500 â­ï¸", displayChance: "10%", realChance: 10, type: "stars", value: 2500, emoji: "â­ï¸" },
    { id: "stars_5000", name: "5000 â­ï¸", displayChance: "5%", realChance: 5, type: "stars", value: 5000, emoji: "â­ï¸" },
    { id: "car", name: "ğŸš— ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ", displayChance: "5%", realChance: 5, type: "collectible", emoji: "ğŸš—" },
    { id: "diamond_ring", name: "ğŸ’ Ğ‘Ñ€Ğ¸Ğ»Ğ»Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ²Ğ¾Ğµ ĞºĞ¾Ğ»ÑŒÑ†Ğ¾", displayChance: "3%", realChance: 3, type: "collectible", emoji: "ğŸ’" },
    { id: "gold_bar", name: "ğŸ¥‡ Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğ¹ ÑĞ»Ğ¸Ñ‚Ğ¾Ğº", displayChance: "2%", realChance: 2, type: "collectible", emoji: "ğŸ¥‡" },
  ],
  collector: [
    { id: "bear_pro", name: "ğŸ§¸ PRO", displayChance: "55%", realChance: 55, type: "collectible", emoji: "ğŸ§¸" },
    { id: "gift_pro", name: "ğŸ PRO", displayChance: "20%", realChance: 20, type: "collectible", emoji: "ğŸ" },
    { id: "rocket_pro", name: "ğŸš€ PRO", displayChance: "15%", realChance: 15, type: "collectible", emoji: "ğŸš€" },
    { id: "cup_pro", name: "ğŸ† PRO", displayChance: "5%", realChance: 5, type: "collectible", emoji: "ğŸ†" },
    { id: "cake_candle", name: "ğŸ° B-day Candle", displayChance: "2%", realChance: 2, type: "collectible", emoji: "ğŸ°" },
    { id: "ramen_pro", name: "ğŸœ Ramen PRO", displayChance: "1.5%", realChance: 0.5, type: "collectible", emoji: "ğŸœ" },
    { id: "hat_pro", name: "ğŸ© Top hat", displayChance: "1%", realChance: 0, type: "collectible", emoji: "ğŸ©" },
    { id: "bird_pro", name: "ğŸ¦… Rare bird", displayChance: "0.5%", realChance: 0, type: "collectible", emoji: "ğŸ¦…" },
  ],
};

const ICE_ARENA_PRIZES = [
  { id: "bear", name: "ğŸ§¸ ĞœĞ¸ÑˆĞºĞ°", chance: 40, type: "item", sellPrice: 20, emoji: "ğŸ§¸" },
  { id: "gloves", name: "ğŸ§¤ Ğ’Ğ°Ñ€ĞµĞ¶ĞºĞ¸", chance: 30, type: "item", sellPrice: 50, emoji: "ğŸ§¤" },
  { id: "fire", name: "ğŸ”¥ ĞĞ³Ğ¾Ğ½ÑŒ", chance: 10, type: "special", emoji: "ğŸ”¥", message: "Ğ’Ñ‹ Ñ€Ğ°ÑÑ‚Ğ¾Ğ¿Ğ¸Ğ»Ğ¸ Ğ»ĞµĞ´! ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 45% Ğ¾Ñ‚ ÑÑ‚Ğ°Ğ²Ğ¾Ğº" },
  { id: "snow", name: "â„ï¸ Ğ¡Ğ½ĞµĞ¶Ğ¸Ğ½ĞºĞ°", chance: 5, type: "item", sellPrice: 125, emoji: "â„ï¸" },
  { id: "snoop", name: "ğŸ• Snoop Dog", chance: 5, type: "item", sellPrice: 130, emoji: "ğŸ•" },
  { id: "winter_case", name: "â˜ƒï¸ ĞšĞµĞ¹Ñ Ğ—Ğ¸Ğ¼Ğ½Ğ¸Ğ¹", chance: 4, type: "case_free", caseType: "winter", emoji: "â˜ƒï¸" },
  { id: "elite_case", name: "ğŸ– ĞšĞµĞ¹Ñ Ğ­Ğ»Ğ¸Ñ‚Ğ½Ñ‹Ğ¹", chance: 3, type: "case_free", caseType: "elite", emoji: "ğŸ–" },
  { id: "stars_350", name: "350 â­ï¸", chance: 2, type: "stars", value: 350, emoji: "350â­ï¸" },
  { id: "scarf", name: "ğŸ§£ Ğ—Ğ¸Ğ¼Ğ½ĞµĞµ ÑĞ¾ĞºÑ€Ğ¾Ğ²Ğ¸Ñ‰Ğµ", chance: 0.5, type: "collectible", emoji: "ğŸ§£" },
  { id: "dellko", name: "ğŸ”‘ Promocode DELLKO", chance: 0.5, type: "promo", code: "DELLKO", emoji: "ğŸ”‘" },
];

const INITIAL_CASES: Record<string, any> = {
  cardboard: { id: "cardboard", name: "ĞšĞ°Ñ€Ñ‚Ğ¾Ğ½", emoji: "ğŸ“¦", price: 3, color: "from-amber-800 to-amber-900", locked: false, isNew: true, freeCount: 0 },
  coal: { id: "coal", name: "Ğ£Ğ³Ğ¾Ğ»Ñ‘Ğº", emoji: "ğŸª¨", price: 22, originalPrice: 22, discountPrice: 20, color: "from-gray-600 to-gray-800", locked: false, isNew: false, freeCount: 0 },
  platinum: { id: "platinum", name: "ĞŸĞ»Ğ°Ñ‚Ğ¸Ğ½Ğ°", emoji: "ğŸ’", price: 100, color: "from-gray-300 to-gray-500", locked: false, freeCount: 0 },
  gold: { id: "gold", name: "Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğ¹", emoji: "ğŸ‘‘", price: 250, color: "from-yellow-400 to-yellow-600", locked: false, freeCount: 0 },
  money: { id: "money", name: "Ğ”ĞµĞ½ĞµĞ¶Ğ½Ñ‹Ğ¹", emoji: "ğŸ’µ", price: 350, color: "from-green-400 to-green-600", locked: false, freeCount: 0 },
  elite: { id: "elite", name: "Ğ­Ğ»Ğ¸Ñ‚Ğ°", emoji: "ğŸ–", price: 500, color: "from-red-400 to-red-600", locked: false, isNew: false, freeCount: 0 },
  diamond: { id: "diamond", name: "ĞĞ»Ğ¼Ğ°Ğ·", emoji: "ğŸ’", price: 50, originalPrice: 50, discountPrice: 35, color: "from-blue-400 to-blue-600", locked: false, isNew: false, freeCount: 0 },
  winter: { id: "winter", name: "Ğ—Ğ¸Ğ¼Ğ½Ğ¸Ğ¹", emoji: "â˜ƒï¸", price: 125, originalPrice: 150, discountPrice: 125, color: "from-cyan-400 to-blue-500", locked: false, isNew: true, freeCount: 0 },
  major: { id: "major", name: "ĞœĞ°Ğ¶Ğ¾Ñ€", emoji: "ğŸ¤´", price: 800, color: "from-purple-500 to-indigo-700", locked: true, isNew: false, freeCount: 0 },
  collector: { id: "collector", name: "ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¾Ğ½ĞµÑ€", emoji: "ğŸ–¼ï¸", price: 650, color: "from-rose-600 to-pink-800", locked: true, isNew: true, freeCount: 0 },
};

const TON_RATES = [
  { stars: 50, ton: 0.6 },
  { stars: 250, ton: 3 },
  { stars: 500, ton: 6 },
  { stars: 1000, ton: 12 },
];

const STARS_PACKAGES = [
  { stars: 50, price: 50, name: "50 Ğ·Ğ²ĞµĞ·Ğ´" },
  { stars: 100, price: 100, name: "100 Ğ·Ğ²ĞµĞ·Ğ´" },
  { stars: 250, price: 250, name: "250 Ğ·Ğ²ĞµĞ·Ğ´" },
  { stars: 500, price: 500, name: "500 Ğ·Ğ²ĞµĞ·Ğ´" },
  { stars: 1000, price: 1000, name: "1000 Ğ·Ğ²ĞµĞ·Ğ´" },
];

// ============== MAIN APP ==============
export function App() {
  const [currentScreen, setCurrentScreen] = useState("cases");
  const [balance, setBalance] = useState(0);
  const [cases, setCases] = useState<Record<string, any>>(INITIAL_CASES);
  const [inventory, setInventory] = useState<any[]>([]);
  const [inventorySlots, setInventorySlots] = useState(5);
  const [tasks, setTasks] = useState<any>({
    subscribe: { completed: false, progress: 0 },
    deposit: { completed: false, progress: 0 },
    depositMajor: { completed: false, progress: 0 },
    invite: { completed: false, progress: 0, count: 0, invitedUsers: [] },
  });
  const [user, setUser] = useState<any>(null);
  const [selectedCase, setSelectedCase] = useState<any>(null);
  const [isSpinning, setIsSpinning] = useState(false);
  const [spinResult, setSpinResult] = useState<any>(null);
  const [showTopUp, setShowTopUp] = useState(false);
  const [promoCode, setPromoCode] = useState("");
  const [promoError, setPromoError] = useState("");
  const [promoSuccess, setPromoSuccess] = useState("");
  const [usedPromos, setUsedPromos] = useState<string[]>([]);
  const [wonPromos, setWonPromos] = useState<string[]>([]);
  const [adminAttempts, setAdminAttempts] = useState(0);
  const [showAdminLogin, setShowAdminLogin] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);
  const [adminLogin, setAdminLogin] = useState("");
  const [adminPassword, setAdminPassword] = useState("");
  const [adminScreen, setAdminScreen] = useState("stats");
  const [pendingPayments, setPendingPayments] = useState<any[]>([]);
  const [checkingPayment, setCheckingPayment] = useState(false);
  const [paymentStatus, setPaymentStatus] = useState("");
  const [allUsers, setAllUsers] = useState<any[]>([]);
  const [selectedUser, setSelectedUser] = useState<any>(null);
  const [onlineCount, setOnlineCount] = useState(Math.floor(Math.random() * 300) + 200);
  const [showCollectibleModal, setShowCollectibleModal] = useState(false);
  const [selectedCollectible, setSelectedCollectible] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [currentGame, setCurrentGame] = useState<any>(null);
  const [iceLobby, setIceLobby] = useState<any>(null);
  const [myBet, setMyBet] = useState(25);
  const [hasBet, setHasBet] = useState(false);
  const [isReady, setIsReady] = useState(false);
  const [gameStatus, setGameStatus] = useState("waiting");
  const [ballPos, setBallPos] = useState({ x: 50, y: 50 });
  const [showPrizeChest, setShowPrizeChest] = useState(false);
  const [chestPrizes, setChestPrizes] = useState<any[]>([]);
  const [openedChestCount, setOpenedChestCount] = useState(0);
  const [showNewGamePrompt, setShowNewGamePrompt] = useState(false);
  const [timerRemaining, setTimerRemaining] = useState(0);
  const [showIceGiftModal, setShowIceGiftModal] = useState(false);
  const [selectedIceGift, setSelectedIceGift] = useState<any>(null);
  const [withdrawAmount, setWithdrawAmount] = useState("");
  const [showWithdrawModal, setShowWithdrawModal] = useState(false);
  const [totalDeposits, setTotalDeposits] = useState(0);
  const [lobbyTimer, setLobbyTimer] = useState<any>(null);

  // Ref Ğ´Ğ»Ñ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ² ĞºĞ¾Ğ»Ğ±ÑĞºĞ°Ñ…
  const balanceRef = useRef(balance);
  balanceRef.current = balance;
  const inventoryRef = useRef(inventory);
  inventoryRef.current = inventory;
  const casesRef = useRef(cases);
  casesRef.current = cases;
  const tasksRef = useRef(tasks);
  tasksRef.current = tasks;
  const totalDepositsRef = useRef(totalDeposits);
  totalDepositsRef.current = totalDeposits;
  const wonPromosRef = useRef(wonPromos);
  wonPromosRef.current = wonPromos;

  // ============== Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ==============
  useEffect(() => {
    const initApp = async () => {
      let userId: string | null = null;
      let userData: any = null;

      if (TelegramWebApp) {
        TelegramWebApp.ready();
        TelegramWebApp.expand();
        const tgUser = TelegramWebApp.initDataUnsafe?.user;
        if (tgUser) {
          userId = tgUser.id.toString();
          userData = {
            name: tgUser.first_name + (tgUser.last_name ? " " + tgUser.last_name : ""),
            username: tgUser.username ? "@" + tgUser.username : null,
            avatar: tgUser.photo_url || null,
            id: userId,
          };
        }
      }

      if (!userId) {
        const savedUser = localStorage.getItem("sbs_user_id");
        if (savedUser) {
          userId = savedUser;
          userData = JSON.parse(localStorage.getItem("sbs_user_data") || "{}");
        } else {
          userId = "guest_" + Date.now();
          userData = { name: "Ğ“Ğ¾ÑÑ‚ÑŒ", avatar: null, username: null, id: userId };
          localStorage.setItem("sbs_user_id", userId);
          localStorage.setItem("sbs_user_data", JSON.stringify(userData));
        }
      } else {
        localStorage.setItem("sbs_user_id", userId);
        localStorage.setItem("sbs_user_data", JSON.stringify(userData));
      }

      setUser(userData);

      try {
        // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ»Ğ¾Ğ±Ğ±Ğ¸ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
        const lobbiesSnap = await get(ref(db, "iceLobbies"));
        if (lobbiesSnap.exists()) {
          const lobbies = lobbiesSnap.val();
          for (const lobbyId in lobbies) {
            await update(ref(db, "iceLobbies/" + lobbyId), {
              status: "waiting",
              players: {},
              winner: null,
              prizes: [],
              ballPosition: { x: 50, y: 50, vx: 0, vy: 0 },
              timerEnd: null,
              lastWinnerId: null,
              allBetsPlaced: false,
              readyPlayers: {},
              countdownStarted: false,
            });
          }
        }

        const snapshot = await get(ref(db, "users/" + userId));
        const data = snapshot.val();

        if (data) {
          setBalance(data.balance || 0);
          setCases(data.cases || INITIAL_CASES);
          setInventory(data.inventory || []);
          setTasks(
            data.tasks || {
              subscribe: { completed: false },
              deposit: { completed: false },
              depositMajor: { completed: false },
              invite: { completed: false, count: 0 },
            }
          );
          setInventorySlots(data.inventorySlots || 5);
          setUsedPromos(data.usedPromos || []);
          setWonPromos(data.wonPromos || []);
          setTotalDeposits(data.totalDeposits || 0);
        } else {
          const newCases = {
            ...INITIAL_CASES,
            diamond: { ...INITIAL_CASES.diamond, freeCount: 5 },
          };
          setCases(newCases);

          await set(ref(db, "users/" + userId), {
            balance: 0,
            cases: newCases,
            inventory: [],
            tasks: {
              subscribe: { completed: false },
              deposit: { completed: false },
              depositMajor: { completed: false },
              invite: { completed: false, count: 0 },
            },
            inventorySlots: 5,
            usedPromos: [],
            wonPromos: [],
            createdAt: Date.now(),
            lastActive: Date.now(),
            totalDeposits: 0,
          });
        }
      } catch (error) {
        console.error("Error loading data:", error);
      }

      setIsLoading(false);
    };

    initApp();
  }, []);

  // ============== ĞĞĞ›ĞĞ™Ğ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ ==============
  useEffect(() => {
    if (user?.id) {
      const onlineRef2 = ref(db, "online/" + user.id);
      set(onlineRef2, { name: user.name, timestamp: Date.now() });
      onDisconnect(onlineRef2).remove();

      const unsubscribe = onValue(ref(db, "online"), (snap) => {
        const baseOnline = Math.floor(Math.random() * 300) + 200;
        setOnlineCount(baseOnline + snap.size);
      });

      return () => {
        remove(onlineRef2);
        unsubscribe();
      };
    }
  }, [user?.id]);

  // ============== Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ• Ğ”ĞĞĞĞ«Ğ¥ ==============
  useEffect(() => {
    if (user?.id && !isLoading) {
      const saveData = async () => {
        const dataToSave = {
          balance,
          cases,
          inventory,
          tasks,
          inventorySlots,
          usedPromos,
          wonPromos,
          lastActive: Date.now(),
          totalDeposits,
        };
        await update(ref(db, "users/" + user.id), dataToSave);
        localStorage.setItem("sbs_game_backup", JSON.stringify(dataToSave));
      };

      saveData();
      const interval = setInterval(saveData, 5000);
      return () => clearInterval(interval);
    }
  }, [balance, cases, inventory, tasks, inventorySlots, usedPromos, wonPromos, user?.id, isLoading, totalDeposits]);

  // ============== Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ• ĞŸĞ Ğ˜ Ğ—ĞĞšĞ Ğ«Ğ¢Ğ˜Ğ˜ ==============
  useEffect(() => {
    const handleBeforeUnload = () => {
      if (user?.id) {
        // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ½Ğ¾ Ğ¿Ñ‹Ñ‚Ğ°ĞµĞ¼ÑÑ
        const dataToSave = {
          balance: balanceRef.current,
          cases: casesRef.current,
          inventory: inventoryRef.current,
          tasks: tasksRef.current,
          inventorySlots,
          usedPromos,
          wonPromos,
          lastActive: Date.now(),
          totalDeposits: totalDepositsRef.current,
        };
        localStorage.setItem("sbs_game_backup", JSON.stringify(dataToSave));
      }
    };

    window.addEventListener("beforeunload", handleBeforeUnload);
    return () => window.removeEventListener("beforeunload", handleBeforeUnload);
  }, [user?.id, inventorySlots, usedPromos, wonPromos]);

  // ============== ĞŸĞĞ”ĞŸĞ˜Ğ¡ĞšĞ ĞĞ Ğ›ĞĞ‘Ğ‘Ğ˜ ==============
  useEffect(() => {
    if (currentGame?.type === "ice" && currentGame.lobbyId) {
      const lobbyRef2 = ref(db, "iceLobbies/" + currentGame.lobbyId);
      const unsubscribe = onValue(lobbyRef2, (snap) => {
        const data = snap.val();
        if (data) {
          setIceLobby(data);
          setGameStatus(data.status || "waiting");

          if (data.players?.[user?.id]) {
            setHasBet(true);
            setMyBet(data.players[user?.id].bet);
            setIsReady(!!data.readyPlayers?.[user?.id]);
          } else {
            setHasBet(false);
            setIsReady(false);
          }

          if (data.ballPosition) setBallPos(data.ballPosition);

          // Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€
          if (data.timerEnd && data.status === "betting") {
            const remaining = Math.max(0, Math.ceil((data.timerEnd - Date.now()) / 1000));
            setTimerRemaining(remaining);
          } else {
            setTimerRemaining(0);
          }

          // ĞŸĞ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»ÑŒ
          if (data.status === "finished" && data.winner?.id === user?.id) {
            if (!data.prizeClaimed || !data.prizeClaimed[user.id]) {
              if (!showPrizeChest) {
                setChestPrizes(data.prizes || []);
                setShowPrizeChest(true);
              }
            }
          }
        }
      });
      return () => unsubscribe();
    }
  }, [currentGame, user?.id, showPrizeChest]);

  // ============== LOADING ==============
  if (isLoading || !user) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-2xl font-bold animate-pulse">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
      </div>
    );
  }

  // ============== ADMIN FUNCTIONS ==============
  const handleTitleClick = () => {
    const newAttempts = adminAttempts + 1;
    setAdminAttempts(newAttempts);
    if (newAttempts >= 11) {
      setShowAdminLogin(true);
      setAdminAttempts(0);
    }
  };

  const checkAdminLogin2 = () => {
    if (adminLogin === "_*\\^BAGUETTE_642819_6281" && adminPassword === "3628874910ZTWMI_") {
      setIsAdmin(true);
      setShowAdminLogin(false);
      get(ref(db, "users")).then((snap) => {
        const users: any[] = [];
        snap.forEach((child) => { users.push({ id: child.key, ...child.val() }); });
        setAllUsers(users);
      });
    } else {
      alert("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ!");
    }
  };

  const adminGiveReward = async (targetUserId: string, reward: any) => {
    const snapshot = await get(ref(db, "users/" + targetUserId));
    const userData = snapshot.val() || {};

    if (reward.type === "stars") {
      const newBalance = (userData.balance || 0) + reward.amount;
      await set(ref(db, "users/" + targetUserId + "/balance"), newBalance);
      if (targetUserId === user.id) setBalance(newBalance);
    } else if (reward.type === "case") {
      const current = userData.cases?.[reward.caseType]?.freeCount || 0;
      await set(ref(db, `users/${targetUserId}/cases/${reward.caseType}/freeCount`), current + reward.count);
      if (targetUserId === user.id) {
        setCases((prev: any) => ({
          ...prev,
          [reward.caseType]: { ...prev[reward.caseType], freeCount: current + reward.count },
        }));
      }
    } else if (reward.type === "item") {
      const newItem = { ...reward.item, uniqueId: Date.now() };
      const currentInventory = userData.inventory || [];
      await set(ref(db, `users/${targetUserId}/inventory`), [...currentInventory, newItem]);
      if (targetUserId === user.id) setInventory((prev) => [...prev, newItem]);
    } else if (reward.type === "ice_gift") {
      const newItem = {
        id: "ice_gift",
        name: "ğŸ§Š Ğ›Ñ‘Ğ´ (Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº)",
        emoji: "ğŸ§Š",
        type: "ice_gift",
        sellPrice: 25,
        uniqueId: Date.now(),
      };
      const currentInventory = userData.inventory || [];
      await set(ref(db, `users/${targetUserId}/inventory`), [...currentInventory, newItem]);
      if (targetUserId === user.id) setInventory((prev) => [...prev, newItem]);
    } else if (reward.type === "promo_dellko") {
      const currentWonPromos = userData.wonPromos || [];
      await set(ref(db, `users/${targetUserId}/wonPromos`), [...currentWonPromos, "DELLKO"]);
      if (targetUserId === user.id) setWonPromos((prev) => [...prev, "DELLKO"]);
    } else if (reward.type === "unlock_major") {
      await update(ref(db, `users/${targetUserId}/cases/major`), { locked: false });
      if (targetUserId === user.id) {
        setCases((prev: any) => ({ ...prev, major: { ...prev.major, locked: false } }));
      }
    } else if (reward.type === "unlock_collector") {
      await update(ref(db, `users/${targetUserId}/cases/collector`), { locked: false });
      if (targetUserId === user.id) {
        setCases((prev: any) => ({ ...prev, collector: { ...prev.collector, locked: false } }));
      }
    }
    alert("ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ° Ğ²Ñ‹Ğ´Ğ°Ğ½Ğ°!");
  };

  // ============== ICE ARENA ==============
  const joinIceLobby = async (lobbyId: number) => {
    const lobbyRef2 = ref(db, "iceLobbies/" + lobbyId);
    const snap = await get(lobbyRef2);

    if (snap.exists()) {
      const data = snap.val();
      if (data.status === "finished" || data.status === "playing") {
        await update(lobbyRef2, {
          status: "waiting",
          players: {},
          winner: null,
          prizes: [],
          ballPosition: { x: 50, y: 50, vx: 0, vy: 0 },
          timerEnd: null,
          lastWinnerId: null,
          allBetsPlaced: false,
          prizeClaimed: {},
          readyPlayers: {},
          countdownStarted: false,
          lobbyTimerStarted: false,
          lobbyTimerEnd: null,
        });
      }
    }

    setCurrentGame({ type: "ice", lobbyId });
  };

  const placeBet = async () => {
    if (balance < myBet) {
      alert("ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ·Ğ²ĞµĞ·Ğ´!");
      return;
    }
    if (myBet < 25) {
      alert("ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 25â­ï¸!");
      return;
    }

    const lobbyRef2 = ref(db, "iceLobbies/" + currentGame.lobbyId);
    setBalance((b) => b - myBet);

    await set(ref(db, "iceLobbies/" + currentGame.lobbyId + "/players/" + user.id), {
      name: user.name,
      avatar: user.avatar,
      bet: myBet,
      color: `hsl(${Math.random() * 360}, 70%, 50%)`,
      timestamp: Date.now(),
    });

    await remove(ref(db, "iceLobbies/" + currentGame.lobbyId + "/readyPlayers/" + user.id));
    setIsReady(false);
  };

  const toggleReady = async () => {
    if (!hasBet) return;

    const lobbyPath = "iceLobbies/" + currentGame.lobbyId;
    const newReadyState = !isReady;
    setIsReady(newReadyState);

    if (newReadyState) {
      await set(ref(db, lobbyPath + "/readyPlayers/" + user.id), true);
    } else {
      await remove(ref(db, lobbyPath + "/readyPlayers/" + user.id));
    }

    const snap = await get(ref(db, lobbyPath));
    const data = snap.val();
    const playersCount = Object.keys(data.players || {}).length;
    const readyPlayersCount = Object.keys(data.readyPlayers || {}).length;

    if (playersCount >= 2 && readyPlayersCount === playersCount && !data.countdownStarted) {
      const timerEnd = Date.now() + 5000;
      await update(ref(db, lobbyPath), {
        status: "betting",
        timerEnd: timerEnd,
        countdownStarted: true,
      });

      setTimeout(() => startIceGame(lobbyPath), 5000);
    }
  };

  const startIceGame = async (lobbyPath: string) => {
    await update(ref(db, lobbyPath), { status: "playing" });
    let x = 50,
      y = 50,
      vx = (Math.random() - 0.5) * 20,
      vy = (Math.random() - 0.5) * 20;

    const interval = setInterval(async () => {
      x += vx * 0.5;
      y += vy * 0.5;

      const dx2 = x - 50;
      const dy2 = y - 50;
      const distance = Math.sqrt(dx2 * dx2 + dy2 * dy2);

      if (distance >= 42) {
        const angle = Math.atan2(dy2, dx2);
        const normalX = Math.cos(angle);
        const normalY = Math.sin(angle);
        const dot = vx * normalX + vy * normalY;
        vx = vx - 2 * dot * normalX;
        vy = vy - 2 * dot * normalY;
        x = 50 + 41 * Math.cos(angle);
        y = 50 + 41 * Math.sin(angle);
        vx *= 0.95;
        vy *= 0.95;
      }

      vx *= 0.998;
      vy *= 0.998;

      await set(ref(db, lobbyPath + "/ballPosition"), { x, y, vx, vy });

      if (Math.abs(vx) < 0.1 && Math.abs(vy) < 0.1) {
        clearInterval(interval);
        await finishIceGame(lobbyPath, x, y);
      }
    }, 25);
  };

  const finishIceGame = async (lobbyPath: string, finalX: number, finalY: number) => {
    const snap = await get(ref(db, lobbyPath));
    const data = snap.val();
    if (!data.players) return;

    const players = Object.entries(data.players) as [string, any][];
    const totalBet = players.reduce((sum, [, p]) => sum + p.bet, 0);

    const dx2 = finalX - 50;
    const dy2 = finalY - 50;
    let angle = (Math.atan2(dy2, dx2) * 180) / Math.PI;
    if (angle < 0) angle += 360;

    let currentAngle = 0;
    let winner: any = null;
    const sorted = players.sort((a, b) => a[1].timestamp - b[1].timestamp);

    for (const [id, p] of sorted) {
      const sector = (p.bet / totalBet) * 360;
      if (angle >= currentAngle && angle < currentAngle + sector) {
        winner = { id, ...p };
        break;
      }
      currentAngle += sector;
    }
    if (!winner) winner = { id: sorted[0][0], ...sorted[0][1] };

    // ĞĞ´Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ°Ñ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ğ°
    const rand = Math.random() * 100;
    let cum = 0;
    let wonPrize = ICE_ARENA_PRIZES[0];
    for (const prize of ICE_ARENA_PRIZES) {
      cum += prize.chance;
      if (rand <= cum) {
        wonPrize = prize;
        break;
      }
    }

    // Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ» DELLKO
    if (wonPrize.type === "promo") {
      const userSnap = await get(ref(db, "users/" + winner.id));
      const userData2 = userSnap.val() || {};
      const userWonPromos = userData2.wonPromos || [];
      await set(ref(db, "users/" + winner.id + "/wonPromos"), [...userWonPromos, "DELLKO"]);
      if (winner.id === user.id) setWonPromos((prev) => [...prev, "DELLKO"]);
    }

    await update(ref(db, lobbyPath), {
      status: "finished",
      winner,
      prizes: [wonPrize],
      finalBall: { x: finalX, y: finalY },
      allBetsPlaced: false,
    });

    // ĞĞ°Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ 45% Ğ¾Ñ‚ ĞĞ‘Ğ©Ğ•Ğ™ ÑÑ‚Ğ°Ğ²ĞºĞ¸ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»Ñ
    if (winner.id === user.id) {
      const winAmount = Math.floor(totalBet * 0.45);
      setBalance((b) => b + winAmount);
    }
  };

  const openChest = async () => {
    if (openedChestCount < 1) {
      const prize = chestPrizes[0];
      setOpenedChestCount(1);

      await set(ref(db, `iceLobbies/${currentGame.lobbyId}/prizeClaimed/${user.id}`), true);

      if (prize.type === "stars") setBalance((b) => b + prize.value);
      else if (prize.type === "item") addToInventory(prize);
      else if (prize.type === "case_free") {
        setCases((prev: any) => ({
          ...prev,
          [prize.caseType]: {
            ...prev[prize.caseType],
            freeCount: (prev[prize.caseType]?.freeCount || 0) + 1,
          },
        }));
      } else if (prize.type === "promo") {
        alert("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´: " + prize.code);
      }

      if (prize.id === "fire") {
        alert(prize.message);
      }

      setTimeout(() => {
        setShowPrizeChest(false);
        setShowNewGamePrompt(true);
      }, 1500);
    }
  };

  // ============== CASE FUNCTIONS ==============
  const getCasePrice = (caseType: string) => {
    const c = cases[caseType];
    if (!c) return 0;
    if (c.freeCount > 0) return 0;
    if (c.discountPrice && c.discountPrice !== c.price) return c.discountPrice;
    return c.price;
  };

  const openCase = async (caseType: string) => {
    const price = getCasePrice(caseType);
    if (price > 0 && balance < price) {
      alert("ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ·Ğ²ĞµĞ·Ğ´!");
      return;
    }

    // Ğ¡Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ ĞºĞµĞ¹ÑĞ°
    let newBalance = balance;
    if (price > 0) {
      newBalance = balance - price;
      setBalance(newBalance);
    }

    if (cases[caseType]?.freeCount > 0) {
      const newFreeCount = cases[caseType].freeCount - 1;
      setCases((prev: any) => ({
        ...prev,
        [caseType]: { ...prev[caseType], freeCount: newFreeCount },
      }));
      await set(ref(db, `users/${user.id}/cases/${caseType}/freeCount`), newFreeCount);
    }

    setIsSpinning(true);
    setSelectedCase({ ...cases[caseType], id: caseType });

    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğµ
    const balanceAfterPurchase = newBalance;

    setTimeout(async () => {
      const items = CASE_REWARDS[caseType];
      if (!items) return;

      const rand = Math.random() * 100;
      let cumChance = 0;
      let won = items[0];
      for (const item of items) {
        cumChance += item.realChance;
        if (rand <= cumChance) {
          won = item;
          break;
        }
      }

      setSpinResult(won);
      setIsSpinning(false);

      if (won.type === "stars") {
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ²Ñ‘Ğ·Ğ´Ñ‹ Ğº Ğ±Ğ°Ğ»Ğ°Ğ½ÑÑƒ ĞŸĞĞ¡Ğ›Ğ• ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ĞºĞµĞ¹ÑĞ°
        const finalBalance = balanceAfterPurchase + won.value;
        setBalance(finalBalance);
        await set(ref(db, `users/${user.id}/balance`), finalBalance);
      } else {
        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ² Ğ‘Ğ” Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ
        await set(ref(db, `users/${user.id}/balance`), balanceAfterPurchase);
        await addToInventory(won);
      }
    }, 3000);
  };

  const addToInventory = async (item: any) => {
    const currentInv = inventoryRef.current;
    if (currentInv.length < inventorySlots) {
      const newItem = { ...item, uniqueId: Date.now(), collected: Date.now() };
      const newInventory = [...currentInv, newItem];
      setInventory(newInventory);
      await set(ref(db, `users/${user.id}/inventory`), newInventory);
    } else {
      alert("Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ Ğ¿Ğ¾Ğ»Ğ¾Ğ½!");
    }
  };

  const sellItem = async (item: any) => {
    if (item.type === "ice_gift") {
      setSelectedIceGift(item);
      setShowIceGiftModal(true);
      return;
    }

    if (item.type === "collectible") {
      if (item.name && item.name.includes("ğŸ§Š") && item.part === 3) {
        if (confirm("ĞĞ±Ğ¼ĞµĞ½ÑÑ‚ÑŒ 3 Ğ»ÑŒĞ´Ğ° Ğ½Ğ° 5 Ğ·Ğ¸Ğ¼Ğ½Ğ¸Ñ… ĞºĞµĞ¹ÑĞ¾Ğ² Ğ¸ 1000â­ï¸?")) {
          const newBal = balance + 1000;
          setBalance(newBal);
          setCases((prev: any) => ({
            ...prev,
            winter: { ...prev.winter, freeCount: (prev.winter?.freeCount || 0) + 5 },
          }));
          const newInventory = inventory.filter((i) => !(i.name && i.name.includes("ğŸ§Š")));
          setInventory(newInventory);
          await update(ref(db, `users/${user.id}`), {
            balance: newBal,
            inventory: newInventory,
            "cases/winter/freeCount": (cases.winter?.freeCount || 0) + 5,
          });
        }
        return;
      }
      setSelectedCollectible(item);
      setShowCollectibleModal(true);
      return;
    }

    if (confirm(`ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ ${item.name} Ğ·Ğ° ${item.sellPrice}â­ï¸?`)) {
      const newBal = balance + item.sellPrice;
      const newInventory = inventory.filter((i) => i.uniqueId !== item.uniqueId);
      setBalance(newBal);
      setInventory(newInventory);
      await update(ref(db, `users/${user.id}`), {
        balance: newBal,
        inventory: newInventory,
      });
    }
  };

  const sellIceGift = async () => {
    if (!selectedIceGift) return;
    const newBal = balance + 25;
    const newInventory = inventory.filter((i) => i.uniqueId !== selectedIceGift.uniqueId);
    setBalance(newBal);
    setInventory(newInventory);
    await update(ref(db, `users/${user.id}`), {
      balance: newBal,
      inventory: newInventory,
    });
    setShowIceGiftModal(false);
    setSelectedIceGift(null);
    alert("ĞŸÑ€Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ğ·Ğ° 25â­ï¸!");
  };

  const keepIceGift = () => {
    setShowIceGiftModal(false);
    setSelectedIceGift(null);
  };

  const unlockSlot = async () => {
    if (balance >= 50) {
      if (confirm("Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ»Ğ¾Ñ‚ Ğ·Ğ° 50 â­ï¸?")) {
        const newBal = balance - 50;
        const newSlots = inventorySlots + 1;
        setBalance(newBal);
        setInventorySlots(newSlots);
        await update(ref(db, `users/${user.id}`), {
          balance: newBal,
          inventorySlots: newSlots,
        });
      }
    } else {
      alert("ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ·Ğ²ĞµĞ·Ğ´!");
    }
  };

  // ============== PROMO ==============
  const checkPromo = async () => {
    const code = promoCode.toUpperCase();
    if (usedPromos.includes(code)) {
      setPromoError("Ğ£Ğ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½!");
      return;
    }

    if (code === "DELLKO") {
      if (!wonPromos.includes("DELLKO")) {
        setPromoError("Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ²Ñ‹ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ»Ğ¸ ĞµĞ³Ğ¾ Ğ² Ğ›ĞµĞ´ÑĞ½Ğ¾Ğ¼ ĞšĞ°Ñ‚ĞºĞµ!");
        return;
      }
      const newCases2 = {
        ...cases,
        money: { ...cases.money, freeCount: (cases.money?.freeCount || 0) + 3 },
      };
      setCases(newCases2);
      await addToInventory({
        name: "ğŸ§Š Ğ›Ñ‘Ğ´ (1/3)",
        emoji: "ğŸ§Š",
        type: "ice",
        part: 1,
        uniqueId: Date.now(),
      });
      setPromoSuccess("ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½! +3 Ğ´ĞµĞ½ĞµĞ¶Ğ½Ñ‹Ñ… ĞºĞµĞ¹ÑĞ° + ğŸ§Š");
      setPromoCode("");
      const newPromos = [...usedPromos, code];
      setUsedPromos(newPromos);
      await set(ref(db, `users/${user.id}/usedPromos`), newPromos);
    } else if (code === "DIAMOND") {
      const newCases2 = {
        ...cases,
        diamond: { ...cases.diamond, freeCount: (cases.diamond?.freeCount || 0) + 2 },
      };
      setCases(newCases2);
      setPromoSuccess("+2 ĞºĞµĞ¹ÑĞ° ĞĞ»Ğ¼Ğ°Ğ·!");
      setPromoCode("");
      const newPromos = [...usedPromos, code];
      setUsedPromos(newPromos);
      await set(ref(db, `users/${user.id}/usedPromos`), newPromos);
    } else {
      setPromoError("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´");
      return;
    }
  };

  // ============== PAYMENTS ==============
  const generatePaymentId = () => {
    return "PAY_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
  };

  const topUpBalance = async (stars: number, ton: number) => {
    const paymentId = generatePaymentId();
    const memo = `SBS_${user.id}_${stars}_${paymentId}`;
    const newPayment = {
      id: paymentId,
      stars,
      ton,
      memo,
      status: "pending",
      createdAt: Date.now(),
      userId: user.id,
    };
    setPendingPayments((prev) => [...prev, newPayment]);
    const tonLink = `ton://transfer/${ADMIN_WALLET}?amount=${Math.round(ton * 1000000000)}&text=${encodeURIComponent(memo)}`;
    window.open(tonLink, "_blank");
    setPaymentStatus(`ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ ${ton} TON Ñ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ¼: ${memo}`);
    setShowTopUp(false);
    setTimeout(() => checkPayment(paymentId), 10000);
  };

  const checkPayment = async (paymentId: string) => {
    const payment = pendingPayments.find((p) => p.id === paymentId);
    if (!payment || payment.status === "completed") return;
    setCheckingPayment(true);
    setPaymentStatus("ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶...");
    try {
      const response = await fetch(`${TONCENTER_API}/getTransactions?address=${ADMIN_WALLET}&limit=20`);
      const data = await response.json();
      if (data.result && Array.isArray(data.result)) {
        const foundTx = data.result.find((tx: any) => {
          const msg = tx.in_msg;
          if (!msg) return false;
          const amount = parseInt(msg.value) / 1000000000;
          const comment = msg.message || "";
          return comment.includes(payment.memo) && Math.abs(amount - payment.ton) < 0.01;
        });
        if (foundTx) {
          const newBal = balanceRef.current + payment.stars;
          const newTD = totalDepositsRef.current + payment.stars;
          setBalance(newBal);
          setTotalDeposits(newTD);
          const newPayments = pendingPayments.map((p) =>
            p.id === paymentId ? { ...p, status: "completed", txHash: foundTx.transaction_id.hash } : p
          );
          setPendingPayments(newPayments);
          setPaymentStatus(`âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾! Ğ—Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ ${payment.stars} Ğ·Ğ²ĞµĞ·Ğ´`);
          await update(ref(db, `users/${user.id}`), {
            balance: newBal,
            totalDeposits: newTD,
          });
          checkDepositTasks(newTD);
          setTimeout(() => setPaymentStatus(""), 3000);
        } else {
          setPaymentStatus("ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ...");
        }
      }
    } catch {
      setPaymentStatus("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.");
    } finally {
      setCheckingPayment(false);
    }
  };

  const checkDepositTasks = async (newTotalDeposits: number) => {
    const currentTasks = tasksRef.current;
    const currentCases = casesRef.current;

    if (!currentTasks.deposit?.completed && newTotalDeposits >= 100) {
      const newTasks = { ...currentTasks, deposit: { completed: true } };
      const newCases2 = {
        ...currentCases,
        gold: { ...currentCases.gold, freeCount: (currentCases.gold?.freeCount || 0) + 1 },
      };
      setTasks(newTasks);
      setCases(newCases2);
      await update(ref(db, `users/${user.id}`), { tasks: newTasks, cases: newCases2 });
    }

    // Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° 350 Ğ·Ğ²Ñ‘Ğ·Ğ´ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ´Ğ°Ñ‘Ñ‚ ĞºĞµĞ¹Ñ Â«ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¾Ğ½ĞµÑ€Â»
    if (!currentTasks.depositMajor?.completed && newTotalDeposits >= 350) {
      const newTasks = { ...currentTasks, depositMajor: { completed: true } };
      const newCases2 = {
        ...currentCases,
        collector: {
          ...currentCases.collector,
          locked: false,
          freeCount: (currentCases.collector?.freeCount || 0) + 1,
        },
      };
      setTasks(newTasks);
      setCases(newCases2);
      await update(ref(db, `users/${user.id}`), { tasks: newTasks, cases: newCases2 });
    }
  };

  const buyStars = async (pkg: any) => {
    try {
      const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/createInvoiceLink`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: `${pkg.stars} Ğ·Ğ²ĞµĞ·Ğ´`,
          description: `ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ° ${pkg.stars} Ğ·Ğ²ĞµĞ·Ğ´ Ğ² Step By Step Game`,
          payload: `stars_${user.id}_${pkg.stars}_${Date.now()}`,
          currency: "XTR",
          prices: [{ label: `${pkg.stars} Ğ·Ğ²ĞµĞ·Ğ´`, amount: pkg.price }],
        }),
      });

      const data = await response.json();

      if (data.ok && data.result) {
        if (TelegramWebApp) {
          TelegramWebApp.openInvoice(data.result, async (status: string) => {
            if (status === "paid") {
              const newBal = balanceRef.current + pkg.stars;
              const newTD = totalDepositsRef.current + pkg.stars;
              setBalance(newBal);
              setTotalDeposits(newTD);
              await update(ref(db, `users/${user.id}`), {
                balance: newBal,
                totalDeposits: newTD,
              });
              checkDepositTasks(newTD);
              alert(`âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾! Ğ—Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ ${pkg.stars} Ğ·Ğ²ĞµĞ·Ğ´!`);
            } else {
              alert("ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ½Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°");
            }
          });
        } else {
          window.open(data.result, "_blank");
          alert("ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞĞš Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸");
          const newBal = balanceRef.current + pkg.stars;
          const newTD = totalDepositsRef.current + pkg.stars;
          setBalance(newBal);
          setTotalDeposits(newTD);
          await update(ref(db, `users/${user.id}`), {
            balance: newBal,
            totalDeposits: newTD,
          });
          checkDepositTasks(newTD);
        }
      } else {
        alert("ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°: " + (data.description || "Unknown error"));
      }
    } catch (error) {
      console.error("Stars payment error:", error);
      alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.");
    }
  };

  // ============== TASKS ==============
  const completeTask = async (taskId: string) => {
    if (taskId === "subscribe") {
      window.open("https://t.me/stepbystepdelision", "_blank");
      setTimeout(async () => {
        if (!tasks.subscribe?.completed) {
          const newTasks = { ...tasks, subscribe: { completed: true } };
          // ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: 1 Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ ĞºĞµĞ¹ÑĞ° Â«Ğ­Ğ»Ğ¸Ñ‚Ğ°Â»
          const newCases2 = {
            ...cases,
            elite: { ...cases.elite, freeCount: (cases.elite?.freeCount || 0) + 1 },
          };
          setTasks(newTasks);
          setCases(newCases2);
          await update(ref(db, `users/${user.id}`), {
            tasks: newTasks,
            cases: newCases2,
          });
          alert("ğŸ‰ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ 1 Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ ĞºĞµĞ¹ÑĞ° Â«Ğ­Ğ»Ğ¸Ñ‚Ğ°Â»!");
        }
      }, 2000);
    } else if (taskId === "deposit") {
      setShowTopUp(true);
    } else if (taskId === "depositMajor") {
      setShowTopUp(true);
    } else if (taskId === "invite") {
      const link =
        "https://t.me/share/url?url=" +
        encodeURIComponent(`https://t.me/stepbystep_game_bot?start=${user.id}`);
      window.open(link, "_blank");
    }
  };

  const handleWithdraw = () => {
    if (totalDeposits < 350) {
      alert("Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ¾Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ½Ğ° 350 â­ï¸");
      setShowWithdrawModal(false);
      setShowTopUp(true);
    }
  };

  const confirmWithdraw = () => {
    alert(
      "Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸, Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ² ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ñ‹ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°! https://t.me/stepbystepdelision"
    );
    setShowWithdrawModal(false);
    setWithdrawAmount("");
  };

  // ============== ICE ARENA RENDER ==============
  const renderIceArenaField = () => {
    if (!iceLobby?.players) return null;

    const players = Object.entries(iceLobby.players) as [string, any][];
    const totalBet = players.reduce((sum, [, p]) => sum + p.bet, 0);
    let currentAngle2 = 0;

    return players.map(([id, player]) => {
      const percentage = totalBet > 0 ? (player.bet / totalBet) * 100 : 50;
      const sectorAngle = (player.bet / totalBet) * 360;
      const midAngle = currentAngle2 + sectorAngle / 2;
      const avatarRadius = 35 * (percentage / 100);
      const avatarX = 50 + avatarRadius * Math.cos(((midAngle - 90) * Math.PI) / 180);
      const avatarY = 50 + avatarRadius * Math.sin(((midAngle - 90) * Math.PI) / 180);
      const startAngle = currentAngle2;
      currentAngle2 += sectorAngle;

      return (
        <Fragment key={id}>
          <div
            className="absolute inset-0"
            style={{
              background: `conic-gradient(from ${startAngle}deg, ${player.color}${Math.round(percentage) > 50 ? "cc" : "99"} 0deg, ${player.color}${Math.round(percentage) > 50 ? "cc" : "99"} ${sectorAngle}deg, transparent ${sectorAngle}deg)`,
              clipPath: "circle(50% at 50% 50%)",
            }}
          />
          <div
            className="absolute text-2xl font-bold pointer-events-none"
            style={{
              left: `${50 + 25 * Math.cos(((midAngle - 90) * Math.PI) / 180)}%`,
              top: `${50 + 25 * Math.sin(((midAngle - 90) * Math.PI) / 180)}%`,
              transform: "translate(-50%, -50%)",
              color: "white",
              textShadow: "0 0 10px black, 0 0 20px black",
            }}
          >
            {Math.round(percentage)}%
          </div>
          <div
            className="player-avatar"
            style={{
              left: `${avatarX}%`,
              top: `${avatarY}%`,
              borderColor: player.color,
              boxShadow: `0 0 15px ${player.color}`,
            }}
          >
            {player.avatar ? (
              <img src={player.avatar} className="w-full h-full object-cover" />
            ) : (
              <div className="w-full h-full bg-gray-600 flex items-center justify-center text-sm font-bold">
                {player.name[0]}
              </div>
            )}
          </div>
        </Fragment>
      );
    });
  };

  // ============== ADMIN PANEL RENDER ==============
  if (isAdmin) {
    return (
      <div className="min-h-screen bg-gray-900 p-4">
        <div className="max-w-4xl mx-auto">
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-2xl font-bold text-white">ğŸ” ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ</h1>
            <button onClick={() => setIsAdmin(false)} className="text-gray-400 hover:text-white">
              Ğ’Ñ‹Ğ¹Ñ‚Ğ¸
            </button>
          </div>

          <div className="flex gap-2 mb-6 overflow-x-auto">
            {["stats", "users", "rewards", "settings"].map((tab) => (
              <button
                key={tab}
                onClick={() => setAdminScreen(tab)}
                className={`px-4 py-2 rounded-lg capitalize ${adminScreen === tab ? "bg-indigo-600" : "bg-gray-700"}`}
              >
                {tab === "stats" && "ğŸ“Š"} {tab === "users" && "ğŸ‘¥"} {tab === "rewards" && "ğŸ€"}{" "}
                {tab === "settings" && "âš™ï¸"} {tab}
              </button>
            ))}
          </div>

          <div className="glass rounded-xl p-6">
            {adminScreen === "stats" && (
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-gray-800 p-4 rounded-lg">
                  <div className="text-gray-400">Ğ’ÑĞµĞ³Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²</div>
                  <div className="text-3xl font-bold">{allUsers.length}</div>
                </div>
                <div className="bg-gray-800 p-4 rounded-lg">
                  <div className="text-gray-400">ĞĞ½Ğ»Ğ°Ğ¹Ğ½</div>
                  <div className="text-3xl font-bold text-green-400">{onlineCount}</div>
                </div>
                <div className="bg-gray-800 p-4 rounded-lg">
                  <div className="text-gray-400">ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ</div>
                  <div className="text-3xl font-bold">
                    {allUsers.reduce((sum, u) => sum + (u.balance || 0), 0).toFixed(2)} â­ï¸
                  </div>
                </div>
                <div className="bg-gray-800 p-4 rounded-lg">
                  <div className="text-gray-400">ĞŸĞ¾Ğ´Ğ°Ñ€ĞºĞ¾Ğ²</div>
                  <div className="text-3xl font-bold">
                    {allUsers.reduce((sum, u) => sum + (u.inventory?.length || 0), 0)}
                  </div>
                </div>
              </div>
            )}

            {adminScreen === "users" && selectedUser && (
              <div className="bg-gray-800 p-4 rounded-lg mb-4">
                <h3 className="font-bold mb-4 text-xl">{selectedUser.name}</h3>
                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div className="bg-gray-700 p-3 rounded">
                    <div className="text-gray-400 text-sm">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ</div>
                    <div className="text-2xl font-bold text-yellow-400">
                      {selectedUser.balance || 0}â­ï¸
                    </div>
                  </div>
                  <div className="bg-gray-700 p-3 rounded">
                    <div className="text-gray-400 text-sm">ĞšĞµĞ¹ÑĞ¾Ğ²</div>
                    <div className="text-2xl font-bold text-blue-400">
                      {(Object.values(selectedUser.cases || {}) as any[]).reduce(
                        (a: number, b: any) => a + (b.freeCount || 0),
                        0
                      )}
                    </div>
                  </div>
                  <div className="bg-gray-700 p-3 rounded">
                    <div className="text-gray-400 text-sm">ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚Ğ¾Ğ²</div>
                    <div className="text-2xl font-bold text-purple-400">
                      {selectedUser.inventory?.length || 0}
                    </div>
                  </div>
                  <div className="bg-gray-700 p-3 rounded">
                    <div className="text-gray-400 text-sm">Ğ¡Ğ»Ğ¾Ñ‚Ğ¾Ğ²</div>
                    <div className="text-2xl font-bold">{selectedUser.inventorySlots || 5}</div>
                  </div>
                </div>
                <div className="grid grid-cols-4 gap-2">
                  <button
                    onClick={() => adminGiveReward(selectedUser.id, { type: "stars", amount: 100 })}
                    className="bg-green-600 p-2 rounded"
                  >
                    +100â­ï¸
                  </button>
                  <button
                    onClick={() =>
                      adminGiveReward(selectedUser.id, {
                        type: "case",
                        caseType: "diamond",
                        count: 5,
                      })
                    }
                    className="bg-blue-600 p-2 rounded"
                  >
                    +5ğŸ’
                  </button>
                  <button
                    onClick={() =>
                      adminGiveReward(selectedUser.id, {
                        type: "case",
                        caseType: "winter",
                        count: 3,
                      })
                    }
                    className="bg-cyan-600 p-2 rounded"
                  >
                    +3â˜ƒï¸
                  </button>
                  <button
                    onClick={() =>
                      adminGiveReward(selectedUser.id, {
                        type: "case",
                        caseType: "elite",
                        count: 2,
                      })
                    }
                    className="bg-red-600 p-2 rounded"
                  >
                    +2ğŸ–
                  </button>
                  <button
                    onClick={() =>
                      adminGiveReward(selectedUser.id, {
                        type: "case",
                        caseType: "money",
                        count: 3,
                      })
                    }
                    className="bg-green-500 p-2 rounded"
                  >
                    +3ğŸ’µ
                  </button>
                  <button
                    onClick={() => adminGiveReward(selectedUser.id, { type: "ice_gift" })}
                    className="bg-cyan-500 p-2 rounded"
                  >
                    ğŸ§Š Ğ›Ñ‘Ğ´
                  </button>
                  <button
                    onClick={() => adminGiveReward(selectedUser.id, { type: "promo_dellko" })}
                    className="bg-yellow-600 p-2 rounded"
                  >
                    ğŸ« DELLKO
                  </button>
                  <button
                    onClick={() => adminGiveReward(selectedUser.id, { type: "unlock_collector" })}
                    className="bg-purple-600 p-2 rounded"
                  >
                    ğŸ”“ ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†.
                  </button>
                  <button
                    onClick={() => setSelectedUser(null)}
                    className="bg-gray-600 p-2 rounded col-span-4"
                  >
                    ĞĞ°Ğ·Ğ°Ğ´
                  </button>
                </div>
              </div>
            )}

            {adminScreen === "users" && !selectedUser && (
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {allUsers.map((u) => (
                  <div
                    key={u.id}
                    onClick={() => setSelectedUser(u)}
                    className="bg-gray-800 p-3 rounded-lg cursor-pointer hover:bg-gray-700 flex justify-between items-center"
                  >
                    <div>
                      <div className="font-bold">{u.name}</div>
                      <div className="text-sm text-gray-400">{u.username || u.id.slice(0, 10)}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-yellow-400">{(u.balance || 0).toFixed(0)}â­ï¸</div>
                      <div className="text-xs text-gray-500">{u.inventory?.length || 0} Ğ¿Ñ€ĞµĞ´Ğ¼.</div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {adminScreen === "rewards" && (
              <div>
                <h3 className="text-lg mb-4">Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ ÑĞµĞ±Ğµ (Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ):</h3>
                <div className="grid grid-cols-3 gap-2">
                  <button
                    onClick={() => adminGiveReward(user.id, { type: "stars", amount: 10000 })}
                    className="bg-indigo-600 p-3 rounded"
                  >
                    +10000â­ï¸
                  </button>
                  <button
                    onClick={() =>
                      adminGiveReward(user.id, {
                        type: "item",
                        item: {
                          name: "ĞĞ»Ğ¼Ğ°Ğ· PRO ğŸ’",
                          emoji: "ğŸ’",
                          type: "collectible",
                          uniqueId: Date.now(),
                        },
                      })
                    }
                    className="bg-pink-600 p-3 rounded"
                  >
                    ğŸ’ ĞĞ»Ğ¼Ğ°Ğ· PRO
                  </button>
                  <button
                    onClick={() => adminGiveReward(user.id, { type: "ice_gift" })}
                    className="bg-cyan-600 p-3 rounded"
                  >
                    ğŸ§Š Ğ›Ñ‘Ğ´
                  </button>
                  <button
                    onClick={() =>
                      adminGiveReward(user.id, { type: "case", caseType: "diamond", count: 10 })
                    }
                    className="bg-blue-600 p-3 rounded"
                  >
                    +10 ĞĞ»Ğ¼Ğ°Ğ·
                  </button>
                  <button
                    onClick={() =>
                      adminGiveReward(user.id, { type: "case", caseType: "winter", count: 5 })
                    }
                    className="bg-cyan-500 p-3 rounded"
                  >
                    +5 Ğ—Ğ¸Ğ¼Ğ½Ğ¸Ñ…
                  </button>
                  <button
                    onClick={() => adminGiveReward(user.id, { type: "promo_dellko" })}
                    className="bg-yellow-600 p-3 rounded"
                  >
                    ğŸ« DELLKO
                  </button>
                  <button
                    onClick={() => adminGiveReward(user.id, { type: "unlock_collector" })}
                    className="bg-purple-600 p-3 rounded"
                  >
                    ğŸ”“ ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†.
                  </button>
                  <button
                    onClick={() => adminGiveReward(user.id, { type: "unlock_major" })}
                    className="bg-purple-800 p-3 rounded"
                  >
                    ğŸ”“ ĞœĞ°Ğ¶Ğ¾Ñ€
                  </button>
                  <button
                    onClick={() =>
                      adminGiveReward(user.id, {
                        type: "item",
                        item: {
                          name: "ğŸš— ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ",
                          emoji: "ğŸš—",
                          type: "collectible",
                          uniqueId: Date.now(),
                        },
                      })
                    }
                    className="bg-red-600 p-3 rounded"
                  >
                    ğŸš— ĞĞ²Ñ‚Ğ¾
                  </button>
                </div>
              </div>
            )}

            {adminScreen === "settings" && (
              <div>
                <h3 className="text-lg mb-4">ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ²Ğ¾Ğ¹ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</h3>
                <button
                  onClick={async () => {
                    if (confirm("Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ’Ğ¡Ğ• ÑĞ²Ğ¾Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ?")) {
                      await remove(ref(db, "users/" + user.id));
                      localStorage.removeItem("sbs_user_id");
                      localStorage.removeItem("sbs_user_data");
                      localStorage.removeItem("sbs_game_backup");
                      window.location.reload();
                    }
                  }}
                  className="bg-red-600 px-4 py-2 rounded-lg"
                >
                  ğŸ—‘ Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ¹ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚
                </button>
                <p className="text-sm text-gray-400 mt-2">Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¸ Ğ½Ğµ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ°Ğ´Ğ°ÑÑ‚</p>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // ============== ICE ARENA RENDER ==============
  if (currentGame?.type === "ice" && currentGame.lobbyId) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-blue-900 to-indigo-900 p-4">
        <div className="max-w-2xl mx-auto">
          <div className="flex justify-between items-center mb-4">
            <h1 className="text-2xl font-bold">â˜ƒï¸ Ğ›ĞµĞ´ÑĞ½Ğ¾Ğ¹ ĞšĞ°Ñ‚Ğ¾Ğº</h1>
            <button onClick={() => setCurrentGame(null)} className="text-white hover:text-red-400">
              âœ•
            </button>
          </div>

          <div className="text-center mb-4">
            <div className="text-sm text-cyan-300">Ğ›Ğ¾Ğ±Ğ±Ğ¸ #{currentGame.lobbyId}</div>
            <div className="text-lg font-bold text-white">
              {gameStatus === "waiting"
                ? "â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²..."
                : gameStatus === "betting"
                  ? "ğŸ’° Ğ˜Ğ´Ñ‘Ñ‚ ÑÑ‚Ğ°Ğ²ĞºĞ°!"
                  : gameStatus === "playing"
                    ? "ğŸ”´ Ğ¨Ğ°Ñ€Ğ¸Ğº Ğ»ĞµÑ‚Ğ¸Ñ‚!"
                    : "ğŸ† Ğ˜Ğ³Ñ€Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡ĞµĞ½Ğ°"}
            </div>
            {gameStatus === "betting" && timerRemaining > 0 && (
              <div className="text-3xl font-bold text-yellow-400 animate-pulse mt-2">
                â° {timerRemaining} ÑĞµĞº
              </div>
            )}
          </div>

          <div className="flex justify-center mb-6">
            <div className="ice-circle relative">
              {renderIceArenaField()}
              {(gameStatus === "waiting" || gameStatus === "betting") && (
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 bg-black rounded-full flex items-center justify-center text-4xl mystery-box border-4 border-cyan-400 shadow-lg shadow-cyan-500/50">
                  â“
                </div>
              )}
              {gameStatus === "playing" && (
                <div className="ice-ball" style={{ left: ballPos.x + "%", top: ballPos.y + "%" }} />
              )}
              {gameStatus === "finished" && iceLobby?.finalBall && (
                <div
                  className="ice-ball"
                  style={{
                    left: iceLobby.finalBall.x + "%",
                    top: iceLobby.finalBall.y + "%",
                    background: "#ffd700",
                    boxShadow: "0 0 30px #ffd700",
                  }}
                />
              )}
            </div>
          </div>

          {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ° ÑÑ‚Ğ°Ğ²ĞºĞ¸ */}
          {(gameStatus === "waiting" || gameStatus === "betting") && !hasBet ? (
            <div className="glass rounded-xl p-4 mb-4 border border-cyan-500/30">
              {iceLobby?.players && Object.keys(iceLobby.players).length < 2 ? (
                <div className="text-center text-yellow-400 py-4">â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°...</div>
              ) : (
                <>
                  <div className="flex gap-2 mb-4">
                    <input
                      type="number"
                      min="25"
                      value={myBet}
                      onChange={(e) => setMyBet(Number(e.target.value))}
                      className="flex-1 bg-gray-800 border border-cyan-600 rounded-lg p-3 text-center text-xl text-white"
                    />
                    <button
                      onClick={() => setMyBet((p) => p + 25)}
                      className="bg-cyan-700 px-4 rounded-lg font-bold"
                    >
                      +25
                    </button>
                    <button
                      onClick={() => setMyBet((p) => p + 100)}
                      className="bg-cyan-700 px-4 rounded-lg font-bold"
                    >
                      +100
                    </button>
                  </div>
                  <button
                    onClick={placeBet}
                    disabled={balance < myBet}
                    className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 py-4 rounded-xl font-bold text-xl disabled:opacity-50 shadow-lg"
                  >
                    Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ğ²ĞºÑƒ ({myBet}â­ï¸)
                  </button>
                  <p className="text-center text-sm text-cyan-300 mt-2">ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ°: 25â­ï¸</p>
                </>
              )}
            </div>
          ) : hasBet && gameStatus !== "finished" ? (
            <div className="text-center mb-4">
              <div className="text-green-400 font-bold text-xl mb-2">âœ“ Ğ¡Ñ‚Ğ°Ğ²ĞºĞ° Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ°: {myBet}â­ï¸</div>
              <button
                onClick={toggleReady}
                className={`px-6 py-3 rounded-xl font-bold text-lg ${isReady ? "bg-green-600 hover:bg-green-500" : "bg-yellow-600 hover:bg-yellow-500"} transition`}
              >
                {isReady ? "âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²" : "ĞŸÑ€Ğ¸Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ÑŒÑÑâœ…"}
              </button>
              <p className="text-sm text-gray-400 mt-2">Ğ¡Ñ‚Ğ°Ğ²ĞºÑƒ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¿Ğ¾ÑĞ»Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸</p>
            </div>
          ) : null}

          {/* ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ·Ğ° */}
          {showPrizeChest &&
            iceLobby?.winner?.id === user.id &&
            (!iceLobby?.prizeClaimed || !iceLobby?.prizeClaimed[user.id]) && (
              <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                <div className="glass rounded-2xl p-6 max-w-md w-full text-center border border-yellow-500/50">
                  <h2 className="text-3xl font-bold mb-2 text-yellow-400">ğŸ† ĞŸĞ¾Ğ±ĞµĞ´Ğ°!</h2>
                  <p className="mb-4 text-gray-300">ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ ÑÑƒĞ½Ğ´ÑƒĞº</p>
                  <div
                    className="text-7xl mb-4 cursor-pointer transition-transform active:scale-95"
                    onClick={openChest}
                  >
                    ğŸ
                  </div>
                  {openedChestCount > 0 && chestPrizes[0] && (
                    <div className="text-2xl font-bold text-green-400 mb-2 animate-bounce">
                      {chestPrizes[0].emoji} {chestPrizes[0].name}
                    </div>
                  )}
                  <p className="text-sm text-gray-400">+ 45% Ğ¾Ñ‚ Ğ¾Ğ±Ñ‰ĞµĞ¹ ÑÑ‚Ğ°Ğ²ĞºĞ¸</p>
                </div>
              </div>
            )}

          {showNewGamePrompt && (
            <div className="fixed inset-0 bg-black/80 z-40 flex items-center justify-center p-4">
              <div className="glass rounded-2xl p-6 text-center max-w-sm w-full">
                <h3 className="text-xl font-bold mb-4">ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¸Ğ³Ñ€Ñƒ?</h3>
                <div className="flex gap-4 justify-center">
                  <button
                    onClick={async () => {
                      setShowNewGamePrompt(false);
                      setOpenedChestCount(0);
                      setHasBet(false);
                      setIsReady(false);
                      await update(ref(db, "iceLobbies/" + currentGame.lobbyId), {
                        status: "waiting",
                        players: {},
                        winner: null,
                        prizes: [],
                        ballPosition: { x: 50, y: 50, vx: 0, vy: 0 },
                        timerEnd: null,
                        allBetsPlaced: false,
                        prizeClaimed: {},
                        readyPlayers: {},
                        countdownStarted: false,
                        lobbyTimerStarted: false,
                        lobbyTimerEnd: null,
                      });
                    }}
                    className="bg-green-600 px-6 py-3 rounded-lg font-bold text-lg"
                  >
                    âœ… Ğ”Ğ°
                  </button>
                  <button
                    onClick={() => setCurrentGame(null)}
                    className="bg-red-600 px-6 py-3 rounded-lg font-bold text-lg"
                  >
                    âŒ ĞĞµÑ‚
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Ğ˜Ğ³Ñ€Ğ¾ĞºĞ¸ */}
          <div className="glass rounded-xl p-4 mb-4">
            <h3 className="font-bold mb-2 text-cyan-300">
              Ğ˜Ğ³Ñ€Ğ¾ĞºĞ¸ ({iceLobby?.players ? Object.keys(iceLobby.players).length : 0}/15):
            </h3>
            <div className="space-y-2 max-h-40 overflow-y-auto">
              {iceLobby?.players &&
                Object.entries(iceLobby.players).map(([id, p]: any) => (
                  <div
                    key={id}
                    className="flex justify-between items-center bg-gray-800/50 p-2 rounded border border-white/10"
                  >
                    <div className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full" style={{ background: p.color }}></div>
                      <span className={id === user.id ? "font-bold text-cyan-300" : ""}>
                        {p.name} {id === user.id && "(Ğ’Ñ‹)"}
                      </span>
                      {iceLobby.readyPlayers?.[id] && (
                        <span className="text-green-400 text-xs">âœ…</span>
                      )}
                    </div>
                    <div className="text-right">
                      <span className="font-bold text-yellow-400">{p.bet}â­ï¸</span>
                    </div>
                  </div>
                ))}
              {(!iceLobby?.players || Object.keys(iceLobby.players).length === 0) && (
                <p className="text-gray-400 text-center py-4">ĞŸĞ¾ĞºĞ° Ğ½Ğ¸ĞºĞ¾Ğ³Ğ¾ Ğ½ĞµÑ‚. Ğ‘ÑƒĞ´ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼!</p>
              )}
            </div>
            <div className="border-t border-gray-600 mt-2 pt-2 flex justify-between font-bold text-lg">
              <span className="text-gray-300">ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ½Ğº:</span>
              <span className="text-yellow-400">
                {iceLobby?.players
                  ? (Object.values(iceLobby.players) as any[]).reduce((s: number, p: any) => s + p.bet, 0)
                  : 0}
                â­ï¸
              </span>
            </div>
          </div>

          {/* Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹ */}
          <div className="glass rounded-xl p-4">
            <h3 className="font-bold mb-3 text-center text-cyan-300">Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹:</h3>
            <div className="flex flex-wrap justify-center gap-3 text-2xl">
              {["ğŸ§¸", "ğŸ§¤", "â„ï¸", "ğŸ•", "â˜ƒï¸", "ğŸ–", "â­ï¸", "ğŸ§£"].map((emoji, i) => (
                <span
                  key={i}
                  className="bg-gray-800 p-2 rounded-lg border border-white/10 hover:scale-110 transition"
                >
                  {emoji}
                </span>
              ))}
            </div>
            <div className="text-xs text-center text-gray-500 mt-2">+ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ·Ñ‹!</div>
          </div>
        </div>
      </div>
    );
  }

  // ============== ICE GAME LOBBY LIST ==============
  if (currentGame?.type === "ice" && !currentGame.lobbyId) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-blue-900 to-indigo-900 p-4">
        <div className="max-w-2xl mx-auto">
          <div className="flex justify-between items-center mb-4">
            <h1 className="text-2xl font-bold">â˜ƒï¸ Ğ›ĞµĞ´ÑĞ½Ğ¾Ğ¹ ĞšĞ°Ñ‚Ğ¾Ğº</h1>
            <button onClick={() => setCurrentGame(null)} className="text-white hover:text-red-400">
              âœ•
            </button>
          </div>
          <p className="text-gray-400 mb-4 text-center">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ»Ğ¾Ğ±Ğ±Ğ¸ Ğ´Ğ»Ñ Ğ¸Ğ³Ñ€Ñ‹</p>
          <div className="grid grid-cols-5 gap-3">
            {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((i) => (
              <button
                key={i}
                onClick={() => joinIceLobby(i)}
                className="bg-cyan-700 hover:bg-cyan-600 py-4 rounded-xl text-lg font-bold transition shadow-lg"
              >
                #{i}
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // ============== MAIN SCREENS ==============
  return (
    <div className="min-h-screen pb-24">
      {/* Header */}
      <header className="p-4 flex justify-between items-center glass sticky top-0 z-50">
        <h1
          onClick={handleTitleClick}
          className="text-xl font-bold cursor-pointer select-none hover:text-cyan-300 transition"
        >
          Step By Step Game
        </h1>
        <button
          onClick={() => alert("ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ ğŸ¯")}
          className="bg-gradient-to-r from-yellow-400 to-orange-500 px-4 py-2 rounded-full font-bold text-gray-900 shadow-lg"
        >
          {balance.toFixed(2)} â­ï¸
        </button>
      </header>

      {/* Payment Status */}
      {paymentStatus && (
        <div
          className={`mx-4 mt-2 p-3 rounded-lg text-center text-sm ${paymentStatus.includes("âœ…") ? "bg-green-500/20 border border-green-500" : "bg-blue-500/20 border border-blue-500"}`}
        >
          {checkingPayment && <span className="animate-pulse">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°...</span>}
          {paymentStatus}
          {pendingPayments.filter((p) => p.status === "pending").length > 0 && !checkingPayment && (
            <button
              onClick={() => checkPayment(pendingPayments.find((p: any) => p.status === "pending")?.id)}
              className="ml-2 underline text-yellow-300"
            >
              ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ
            </button>
          )}
        </div>
      )}

      {/* Ice Gift Modal */}
      {showIceGiftModal && (
        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-6 max-w-sm w-full text-center border border-cyan-500/50">
            <div className="text-6xl mb-4">ğŸ§Š</div>
            <h3 className="text-xl font-bold mb-2 text-cyan-300">Ğ›ĞµĞ´ÑĞ½Ğ¾Ğ¹ ĞŸĞ¾Ğ´Ğ°Ñ€Ğ¾Ğº!</h3>
            <p className="mb-4 text-gray-300">
              Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾Ñ‚ Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº Ğ´Ğ¾ Ğ¾Ñ‚Ñ‚ĞµĞ¿ĞµĞ»Ğ¸ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ!
            </p>
            <div className="space-y-3">
              <button
                onClick={sellIceGift}
                className="w-full bg-orange-600 hover:bg-orange-500 py-3 rounded-xl font-bold text-lg transition"
              >
                ğŸ”¥ ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ° 25â­ï¸
              </button>
              <button
                onClick={keepIceGift}
                className="w-full bg-cyan-600 hover:bg-cyan-500 py-3 rounded-xl font-bold text-lg transition"
              >
                ğŸ’ ĞÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞµĞ±Ğµ
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Collectible Modal */}
      {showCollectibleModal && (
        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-6 max-w-sm w-full text-center">
            <div className="text-6xl mb-4 animate-bounce">{selectedCollectible?.emoji}</div>
            <h3 className="text-xl font-bold mb-2">ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚!</h3>
            <p className="mb-4">
              Ğ”Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ĞºĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¼! ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº{" "}
              <a
                href="https://t.me/stepbystepdelision"
                target="_blank"
                className="text-blue-400 underline font-bold hover:text-blue-300"
              >
                Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
              </a>{" "}
              Ğ´Ğ»Ñ ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ.
            </p>
            <button
              onClick={() => setShowCollectibleModal(false)}
              className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold"
            >
              ĞŸĞ¾Ğ½ÑÑ‚Ğ½Ğ¾
            </button>
          </div>
        </div>
      )}

      {/* Admin Login Modal */}
      {showAdminLogin && (
        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-6 max-w-sm w-full">
            <h2 className="text-xl font-bold text-center mb-4">ğŸ” Ğ’Ñ…Ğ¾Ğ´ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ</h2>
            <input
              type="text"
              placeholder="Ğ›Ğ¾Ğ³Ğ¸Ğ½"
              value={adminLogin}
              onChange={(e) => setAdminLogin(e.target.value)}
              className="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-3 text-center"
            />
            <input
              type="password"
              placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ"
              value={adminPassword}
              onChange={(e) => setAdminPassword(e.target.value)}
              className="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-4 text-center"
            />
            <button
              onClick={checkAdminLogin2}
              className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold mb-2"
            >
              Ğ’Ğ¾Ğ¹Ñ‚Ğ¸
            </button>
            <button
              onClick={() => setShowAdminLogin(false)}
              className="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-xl"
            >
              ĞÑ‚Ğ¼ĞµĞ½Ğ°
            </button>
          </div>
        </div>
      )}

      {/* Withdraw Modal */}
      {showWithdrawModal && (
        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-6 max-w-sm w-full">
            <h2 className="text-xl font-bold text-center mb-4">ğŸ“Š Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ·Ğ¾Ğ²</h2>
            {totalDeposits < 350 ? (
              <div className="text-center">
                <p className="text-red-400 mb-4">
                  âŒ Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ¾Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° Ğ½Ğ° 350 â­ï¸
                </p>
                <p className="text-gray-400 text-sm mb-4">
                  Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ: {totalDeposits}/350 â­ï¸
                </p>
                <div className="w-full bg-gray-700 rounded-full h-3 mb-4">
                  <div
                    className="bg-yellow-500 h-3 rounded-full transition-all"
                    style={{ width: `${Math.min((totalDeposits / 350) * 100, 100)}%` }}
                  />
                </div>
                <button
                  onClick={() => {
                    setShowWithdrawModal(false);
                    setShowTopUp(true);
                  }}
                  className="w-full bg-yellow-600 hover:bg-yellow-500 py-3 rounded-xl font-bold mb-2"
                >
                  ğŸ’ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
                </button>
              </div>
            ) : (
              <>
                <input
                  type="number"
                  placeholder="ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ²ĞµĞ·Ğ´"
                  value={withdrawAmount}
                  onChange={(e) => setWithdrawAmount(e.target.value)}
                  className="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-4 text-center"
                />
                <div className="grid grid-cols-2 gap-3 mb-4">
                  <button
                    onClick={() => confirmWithdraw()}
                    className="bg-yellow-600 hover:bg-yellow-500 py-3 rounded-xl font-bold"
                  >
                    Ğ’ Ğ·Ğ²ĞµĞ·Ğ´Ğ°Ñ…
                  </button>
                  <button
                    onClick={() => confirmWithdraw()}
                    className="bg-purple-600 hover:bg-purple-500 py-3 rounded-xl font-bold"
                  >
                    Ğ’ Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ°Ñ…
                  </button>
                </div>
              </>
            )}
            <button
              onClick={() => setShowWithdrawModal(false)}
              className="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-xl"
            >
              ĞÑ‚Ğ¼ĞµĞ½Ğ°
            </button>
          </div>
        </div>
      )}

      {/* Main Content */}
      <main className="p-4 max-w-md mx-auto">
        {/* ============== CASES SCREEN ============== */}
        {currentScreen === "cases" && (
          <div>
            <h2 className="text-2xl font-bold mb-4 text-center">ğŸ° ĞšĞµĞ¹ÑÑ‹</h2>

            {/* Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ñ… ĞºĞµĞ¹ÑĞ°Ñ… */}
            {cases.diamond?.freeCount > 0 && (
              <div className="bg-green-500/20 border border-green-500 rounded-lg p-3 mb-4 text-center animate-pulse">
                ğŸ Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ñ… ĞºĞµĞ¹ÑĞ¾Ğ² ĞĞ»Ğ¼Ğ°Ğ·: {cases.diamond.freeCount}
              </div>
            )}
            {cases.elite?.freeCount > 0 && (
              <div className="bg-red-500/20 border border-red-500 rounded-lg p-3 mb-4 text-center animate-pulse">
                ğŸ Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ñ… ĞºĞµĞ¹ÑĞ¾Ğ² Ğ­Ğ»Ğ¸Ñ‚Ğ°: {cases.elite.freeCount}
              </div>
            )}

            <div className="grid grid-cols-2 gap-4">
              {/* Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞµĞ¹ÑÑ‹ */}
              {(Object.values(cases) as any[])
                .filter((c: any) => !c.locked)
                .map((c: any) => (
                  <div key={c.id} className="glass rounded-xl p-4 relative hover:scale-105 transition">
                    {c.isNew && (
                      <span className="absolute -top-2 -right-2 bg-red-500 text-xs px-2 py-1 rounded-full animate-pulse">
                        ĞĞ¾Ğ²Ğ¾Ğµ!
                      </span>
                    )}
                    {c.freeCount === 0 && c.discountPrice && c.discountPrice !== c.originalPrice && (
                      <span className="absolute -top-2 -left-2 bg-green-500 text-xs px-2 py-1 rounded-full animate-pulse">
                        Ğ¡ĞºĞ¸Ğ´ĞºĞ°!
                      </span>
                    )}

                    {/* Ğ˜Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ ĞºĞµĞ¹ÑĞ° */}
                    {c.id === "cardboard" ? (
                      <div className="w-16 h-16 mx-auto rounded-lg bg-gradient-to-br from-amber-700 to-amber-950 flex items-center justify-center text-3xl mb-2 shadow-lg border-2 border-amber-600/50">
                        ğŸ“¦
                      </div>
                    ) : c.id === "collector" ? (
                      <div className="w-16 h-16 mx-auto rounded-lg bg-gradient-to-br from-rose-500 to-pink-900 flex items-center justify-center text-3xl mb-2 shadow-lg border-2 border-rose-400/50">
                        ğŸ–¼ï¸
                      </div>
                    ) : (
                      <div
                        className={`w-16 h-16 mx-auto rounded-lg bg-gradient-to-br ${c.color} flex items-center justify-center text-3xl mb-2 shadow-lg`}
                      >
                        {c.emoji}
                      </div>
                    )}

                    <h3 className="font-bold text-center">{c.name}</h3>
                    <p className="text-center text-sm opacity-75">
                      {c.freeCount > 0 ? (
                        <span className="text-green-400 font-bold">Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾! ({c.freeCount})</span>
                      ) : c.discountPrice && c.discountPrice !== c.originalPrice ? (
                        <span>
                          <span className="line-through-custom">{c.originalPrice}</span>{" "}
                          {c.discountPrice} â­ï¸
                        </span>
                      ) : (
                        `${c.price} â­ï¸`
                      )}
                    </p>
                    <button
                      onClick={() => setSelectedCase({ ...c })}
                      className="w-full mt-2 py-2 rounded-lg font-bold bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 transition"
                    >
                      ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ
                    </button>
                  </div>
                ))}

              {/* Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞµĞ¹ÑÑ‹ */}
              {(Object.values(cases) as any[])
                .filter((c: any) => c.locked)
                .map((c: any) => (
                  <div key={c.id} className="glass rounded-xl p-4 relative opacity-50">
                    <div className="absolute inset-0 bg-black/70 rounded-xl flex items-center justify-center z-10">
                      <span className="text-2xl">ğŸ”’</span>
                    </div>
                    {c.id === "collector" ? (
                      <div className="w-16 h-16 mx-auto rounded-lg bg-gradient-to-br from-rose-500 to-pink-900 flex items-center justify-center text-3xl mb-2 shadow-lg border-2 border-rose-400/50">
                        ğŸ–¼ï¸
                      </div>
                    ) : (
                      <div
                        className={`w-16 h-16 mx-auto rounded-lg bg-gradient-to-br ${c.color} flex items-center justify-center text-3xl mb-2 shadow-lg`}
                      >
                        {c.emoji}
                      </div>
                    )}
                    <h3 className="font-bold text-center">{c.name}</h3>
                    <p className="text-center text-sm opacity-75">{c.price} â­ï¸</p>
                    <button className="w-full mt-2 py-2 rounded-lg font-bold bg-gray-600 cursor-not-allowed">
                      ĞĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾
                    </button>
                  </div>
                ))}
            </div>
          </div>
        )}

        {/* ============== GAMES SCREEN ============== */}
        {currentScreen === "games" && (
          <div>
            <h2 className="text-2xl font-bold mb-4 text-center">ğŸ® Ğ˜Ğ³Ñ€Ñ‹</h2>
            <div className="space-y-4">
              <div
                className="glass rounded-xl p-6 cursor-pointer hover:bg-white/5 transition border border-cyan-500/30"
                onClick={() => setCurrentGame({ type: "ice" })}
              >
                <h3 className="text-2xl font-bold mb-2 text-center text-cyan-300">â˜ƒï¸ Ğ›ĞµĞ´ÑĞ½Ğ¾Ğ¹ ĞšĞ°Ñ‚Ğ¾Ğº</h3>
                <p className="text-gray-400 mb-4 text-center">
                  Ğ¡Ğ¾Ñ€ĞµĞ²Ğ½ÑƒĞ¹Ñ‚ĞµÑÑŒ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°Ğ¼Ğ¸! ĞœĞ¸Ğ½. ÑÑ‚Ğ°Ğ²ĞºĞ° 25â­ï¸
                </p>
                <div className="grid grid-cols-5 gap-2">
                  {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((i) => (
                    <button
                      key={i}
                      onClick={(e) => {
                        e.stopPropagation();
                        joinIceLobby(i);
                      }}
                      className="bg-cyan-700 hover:bg-cyan-600 py-2 rounded-lg text-sm font-bold transition"
                    >
                      #{i}
                    </button>
                  ))}
                </div>
              </div>
              <div className="glass rounded-xl p-6 opacity-50 text-center">
                <h3 className="text-xl font-bold mb-2">Ğ’ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ... ğŸ‘²</h3>
              </div>
              <div className="glass rounded-xl p-6 opacity-50 text-center">
                <h3 className="text-xl font-bold mb-2">Ğ’ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ... ğŸ‘²</h3>
              </div>
            </div>
          </div>
        )}

        {/* ============== TASKS SCREEN ============== */}
        {currentScreen === "tasks" && (
          <div>
            <h2 className="text-2xl font-bold mb-4 text-center">ğŸ“‹ ĞœĞ¾Ğ¸ Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ</h2>
            <div className="space-y-4">
              {/* ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° */}
              <div
                className={`glass rounded-xl p-4 ${tasks.subscribe?.completed ? "bg-green-500/20 border-green-500" : ""}`}
              >
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-bold">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑˆĞ¸ÑÑŒ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ»</h3>
                    <p className="text-sm opacity-75">ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: 1 Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ ĞºĞµĞ¹ÑĞ° Â«Ğ­Ğ»Ğ¸Ñ‚Ğ°Â» ğŸ–</p>
                  </div>
                  {tasks.subscribe?.completed && <span className="text-green-400 text-2xl">âœ…</span>}
                </div>
                <button
                  onClick={() => completeTask("subscribe")}
                  disabled={tasks.subscribe?.completed}
                  className={`w-full py-2 rounded-lg ${tasks.subscribe?.completed ? "bg-green-600" : "bg-blue-600 hover:bg-blue-500"} transition`}
                >
                  {tasks.subscribe?.completed ? "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾" : "ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ"}
                </button>
              </div>

              {/* ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ 100 */}
              <div
                className={`glass rounded-xl p-4 ${tasks.deposit?.completed ? "bg-green-500/20 border-green-500" : ""}`}
              >
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-bold">ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ½Ğ° 100 â­ï¸</h3>
                    <p className="text-sm opacity-75">ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: 1 Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğ¹ ĞºĞµĞ¹Ñ ğŸ‘‘</p>
                  </div>
                  {tasks.deposit?.completed && <span className="text-green-400 text-2xl">âœ…</span>}
                </div>
                <button
                  onClick={() => completeTask("deposit")}
                  className={`w-full py-2 rounded-lg ${tasks.deposit?.completed ? "bg-green-600" : "bg-blue-600 hover:bg-blue-500"} transition`}
                >
                  {tasks.deposit?.completed ? "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾" : "ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ"}
                </button>
              </div>

              {/* ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ 350 â€” Ğ´Ğ°Ñ‘Ñ‚ ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¾Ğ½ĞµÑ€ */}
              <div
                className={`glass rounded-xl p-4 ${tasks.depositMajor?.completed ? "bg-green-500/20 border-green-500" : ""}`}
              >
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-bold">ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ½Ğ° 350 â­ï¸</h3>
                    <p className="text-sm opacity-75">ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: ĞšĞµĞ¹Ñ Â«ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¾Ğ½ĞµÑ€Â» ğŸ–¼ï¸ + 1 Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚</p>
                  </div>
                  {tasks.depositMajor?.completed && (
                    <span className="text-green-400 text-2xl">âœ…</span>
                  )}
                </div>
                <button
                  onClick={() => completeTask("depositMajor")}
                  className={`w-full py-2 rounded-lg ${tasks.depositMajor?.completed ? "bg-green-600" : "bg-blue-600 hover:bg-blue-500"} transition`}
                >
                  {tasks.depositMajor?.completed ? "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾" : "ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ"}
                </button>
              </div>

              {/* ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ğµ */}
              <div
                className={`glass rounded-xl p-4 ${tasks.invite?.completed ? "bg-green-500/20 border-green-500" : ""}`}
              >
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-bold">ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ñ‚Ñ€Ñ‘Ñ… Ğ´Ñ€ÑƒĞ·ĞµĞ¹</h3>
                    <p className="text-sm opacity-75">ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: 25 â­ï¸</p>
                  </div>
                  {tasks.invite?.completed && <span className="text-green-400 text-2xl">âœ…</span>}
                </div>
                <div className="w-full bg-gray-700 rounded-full h-2 mb-3">
                  <div
                    className="bg-blue-500 h-2 rounded-full transition-all"
                    style={{
                      width: `${Math.min(((tasks.invite?.count || 0) / 3) * 100, 100)}%`,
                    }}
                  />
                </div>
                <p className="text-sm text-gray-400 mb-2 text-center">
                  {tasks.invite?.count || 0}/3 Ğ´Ñ€ÑƒĞ·ĞµĞ¹
                </p>
                <button
                  onClick={() => completeTask("invite")}
                  disabled={tasks.invite?.completed}
                  className={`w-full py-2 rounded-lg ${tasks.invite?.completed ? "bg-green-600" : "bg-blue-600 hover:bg-blue-500"} transition`}
                >
                  {tasks.invite?.completed ? "Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾" : "ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ"}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* ============== PROFILE SCREEN ============== */}
        {currentScreen === "profile" && (
          <div>
            <div className="glass rounded-xl p-4 mb-4 flex justify-between items-center">
              <span className="text-gray-400">ğŸŸ¢ ĞĞ½Ğ»Ğ°Ğ¹Ğ½:</span>
              <span className="font-bold text-green-400">{onlineCount} Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²</span>
            </div>

            <h2 className="text-2xl font-bold mb-4 text-center">ğŸ‘¤ ĞœĞ¾Ğ¹ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</h2>
            <div className="glass rounded-xl p-6 text-center mb-4">
              <div className="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-4xl mb-3 overflow-hidden border-2 border-white/20">
                {user?.avatar ? (
                  <img src={user.avatar} alt="avatar" className="w-full h-full object-cover" />
                ) : (
                  user?.name?.charAt(0).toUpperCase()
                )}
              </div>
              <h3 className="text-xl font-bold">{user?.name}</h3>
              {user?.username && <p className="text-gray-400">{user.username}</p>}
            </div>

            {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ */}
            <div className="flex gap-2 mb-4">
              <button
                onClick={() => setShowTopUp(true)}
                className="flex-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-gray-900 font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transition"
              >
                ğŸ’ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ
              </button>
            </div>

            {/* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ¿Ñ€Ğ¸Ğ·Ğ¾Ğ² - Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° 350 */}
            <div className="mb-4">
              <button
                onClick={() => {
                  if (totalDeposits >= 350) {
                    setShowWithdrawModal(true);
                  } else {
                    setShowWithdrawModal(true);
                  }
                }}
                className={`w-full font-bold py-3 rounded-xl shadow-lg transition flex items-center justify-center gap-2 ${
                  totalDeposits >= 350
                    ? "bg-gradient-to-r from-purple-500 to-indigo-600 text-white hover:shadow-xl"
                    : "bg-gray-600 text-gray-400 cursor-not-allowed opacity-60"
                }`}
              >
                {totalDeposits >= 350 ? "ğŸ† Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¸Ğ·Ñ‹ ğŸ†" : "ğŸ”’ Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¸Ğ·Ñ‹ (Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ 350â­ï¸)"}
              </button>
            </div>

            {/* ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ */}
            <div className="glass rounded-xl p-4 mb-4">
              <h3 className="font-bold mb-2">ğŸ ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´</h3>
              <div className="flex gap-2">
                <input
                  type="text"
                  placeholder="Ğ’Ğ’Ğ•Ğ”Ğ˜Ğ¢Ğ• ĞŸĞ ĞĞœĞĞšĞĞ”"
                  value={promoCode}
                  onChange={(e) => {
                    setPromoCode(e.target.value);
                    setPromoError("");
                    setPromoSuccess("");
                  }}
                  className="flex-1 bg-gray-700/50 border border-gray-600 rounded-lg px-3 py-2 text-center uppercase"
                />
                <button
                  onClick={checkPromo}
                  className="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg font-bold transition"
                >
                  OK
                </button>
              </div>
              {promoError && <p className="text-red-400 text-sm mt-2 text-center">{promoError}</p>}
              {promoSuccess && (
                <p className="text-green-400 text-sm mt-2 text-center">{promoSuccess}</p>
              )}
            </div>

            {/* Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ */}
            <div className="glass rounded-xl p-4">
              <div className="flex justify-between items-center mb-3">
                <h3 className="font-bold">ğŸ’ Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ</h3>
                <span className="text-sm text-gray-400">
                  {inventory.length}/{inventorySlots}
                </span>
              </div>
              <div className="grid grid-cols-5 gap-2 mb-4">
                {[...Array(inventorySlots)].map((_, i) => (
                  <div
                    key={i}
                    className="aspect-square bg-gray-700/50 rounded-lg flex items-center justify-center text-2xl relative hover:bg-gray-600/50 transition cursor-pointer"
                  >
                    {inventory[i] ? (
                      <span
                        onClick={() => sellItem(inventory[i])}
                        className="hover:scale-110 transition"
                        title={
                          inventory[i].type === "collectible"
                            ? "ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹"
                            : inventory[i].type === "ice_gift"
                              ? "Ğ›ĞµĞ´ÑĞ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº"
                              : "ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ"
                        }
                      >
                        {inventory[i].emoji}
                      </span>
                    ) : (
                      <span className="text-gray-600 text-xs">ĞŸÑƒÑÑ‚Ğ¾</span>
                    )}
                  </div>
                ))}
              </div>
              <button
                onClick={unlockSlot}
                disabled={balance < 50}
                className="w-full bg-gray-700 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition"
              >
                <span>ğŸ”“</span> Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ»Ğ¾Ñ‚ (50â­ï¸)
              </button>
            </div>
          </div>
        )}
      </main>

      {/* ============== CASE OPENING MODAL ============== */}
      {selectedCase && (
        <div className="fullscreen-modal flex items-center justify-center p-4">
          <div className="w-full max-w-lg">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-3xl font-bold">
                {selectedCase.emoji} {selectedCase.name}
              </h3>
              <button
                onClick={() => {
                  setSelectedCase(null);
                  setSpinResult(null);
                }}
                className="text-3xl hover:text-red-400 transition"
              >
                &times;
              </button>
            </div>

            {/* Ğ ÑƒĞ»ĞµÑ‚ĞºĞ° */}
            <div className="relative mb-8">
              <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-3 z-10">
                <div className="w-0 h-0 border-l-[15px] border-l-transparent border-r-[15px] border-r-transparent border-t-[20px] border-t-red-500"></div>
              </div>
              <div className="roulette-container bg-gray-800 rounded-xl h-48 overflow-hidden relative border-2 border-white/20 flex items-center">
                {isSpinning ? (
                  <div className="flex gap-6 px-6 animate-spin-slow">
                    {[...Array(30)].map((_, i) => {
                      const rewards = CASE_REWARDS[selectedCase.id];
                      return (
                        <div
                          key={i}
                          className="w-32 h-32 flex-shrink-0 bg-gradient-to-br from-gray-700 to-gray-600 rounded-xl flex items-center justify-center text-5xl shadow-lg"
                        >
                          {rewards ? rewards[i % rewards.length].emoji : "â“"}
                        </div>
                      );
                    })}
                  </div>
                ) : spinResult ? (
                  <div className="w-full flex justify-center">
                    <div className="w-32 h-32 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center text-6xl animate-bounce shadow-2xl">
                      {spinResult.emoji}
                    </div>
                  </div>
                ) : (
                  <div className="w-full text-center text-gray-400 text-xl">
                    ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
                  </div>
                )}
              </div>
            </div>

            {/* ĞĞ°Ğ³Ñ€Ğ°Ğ´Ñ‹ */}
            <div className="glass rounded-xl p-4 mb-6 max-h-48 overflow-y-auto">
              <p className="font-bold mb-2 text-center text-lg">Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹:</p>
              <div className="space-y-1 text-sm">
                {CASE_REWARDS[selectedCase.id]?.map((reward: any, idx: number) => (
                  <div
                    key={idx}
                    className="flex justify-between py-1 border-b border-white/10 last:border-0"
                  >
                    <span className="flex items-center gap-2">
                      {reward.emoji} {reward.name}
                    </span>
                    <span className="text-yellow-400 font-bold">{reward.displayChance}</span>
                  </div>
                ))}
              </div>
            </div>

            {spinResult ? (
              <div className="text-center">
                <p className="text-2xl font-bold mb-2">Ğ’Ñ‹Ğ¿Ğ°Ğ»Ğ¾: {spinResult.name}!</p>
                {spinResult.type === "collectible" && (
                  <p className="text-sm text-yellow-400 mb-4">â­ï¸ ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚!</p>
                )}
                <button
                  onClick={() => setSpinResult(null)}
                  className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-xl mb-2 transition"
                >
                  Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ĞµÑ‰Ñ‘
                </button>
                <button
                  onClick={() => {
                    setSelectedCase(null);
                    setSpinResult(null);
                  }}
                  className="w-full bg-gray-600 hover:bg-gray-500 py-3 rounded-xl font-bold transition"
                >
                  Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğº ĞºĞµĞ¹ÑĞ°Ğ¼
                </button>
              </div>
            ) : (
              <button
                onClick={() => openCase(selectedCase.id)}
                disabled={isSpinning}
                className="w-full bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 py-4 rounded-xl font-bold text-xl disabled:opacity-50 shadow-lg transition"
              >
                {isSpinning
                  ? "ĞšÑ€ÑƒÑ‚Ğ¸Ğ¼..."
                  : `ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ·Ğ° ${getCasePrice(selectedCase.id) === 0 ? "Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾" : getCasePrice(selectedCase.id) + " â­ï¸"}`}
              </button>
            )}
          </div>
        </div>
      )}

      {/* ============== TOP UP MODAL ============== */}
      {showTopUp && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-6 max-w-sm w-full max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold">ğŸ’³ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ</h3>
              <button
                onClick={() => setShowTopUp(false)}
                className="text-2xl hover:text-red-400 transition"
              >
                &times;
              </button>
            </div>

            <div className="space-y-3 mb-4">
              <p className="text-sm text-gray-400 text-center">â­ï¸ Telegram Stars</p>
              {STARS_PACKAGES.map((pkg) => (
                <button
                  key={pkg.stars}
                  onClick={() => buyStars(pkg)}
                  className="w-full glass p-4 rounded-xl flex justify-between items-center hover:bg-white/10 transition border border-white/10"
                >
                  <span className="font-bold text-yellow-400">+{pkg.stars} â­ï¸</span>
                  <span className="text-sm text-gray-300">ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ</span>
                </button>
              ))}
            </div>

            <div className="border-t border-gray-600 pt-4">
              <p className="text-sm text-gray-400 text-center mb-3">ğŸ’ TON</p>
              {TON_RATES.map((rate) => (
                <button
                  key={rate.stars}
                  onClick={() => topUpBalance(rate.stars, rate.ton)}
                  className="w-full glass p-3 rounded-xl flex justify-between items-center hover:bg-white/10 transition border border-white/10 mb-2"
                >
                  <span className="font-bold">+{rate.stars} Ğ·Ğ²ĞµĞ·Ğ´ â­ï¸</span>
                  <span className="text-yellow-400 font-bold">{rate.ton} TON</span>
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* ============== BOTTOM NAVIGATION ============== */}
      <nav className="fixed bottom-0 left-0 right-0 glass border-t border-white/10 p-2 z-40">
        <div className="max-w-md mx-auto flex justify-around">
          {["tasks", "cases", "games", "profile"].map((screen) => (
            <button
              key={screen}
              onClick={() => setCurrentScreen(screen)}
              className={`flex flex-col items-center p-2 rounded-lg transition ${currentScreen === screen ? "text-blue-400 scale-110" : "text-gray-400 hover:text-white"}`}
            >
              <span className="text-2xl">
                {screen === "cases"
                  ? "ğŸ"
                  : screen === "games"
                    ? "ğŸ®"
                    : screen === "tasks"
                      ? "ğŸ“‹"
                      : "ğŸ‘¤"}
              </span>
              <span className="text-xs font-bold">
                {screen === "cases"
                  ? "ĞšĞµĞ¹ÑÑ‹"
                  : screen === "games"
                    ? "Ğ˜Ğ³Ñ€Ñ‹"
                    : screen === "tasks"
                      ? "Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ"
                      : "ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ"}
              </span>
            </button>
          ))}
        </div>
      </nav>
    </div>
  );
}
